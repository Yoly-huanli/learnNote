[toc]

# 1.å¼‚æ­¥åŠ è½½

## asyncå’Œdeferçš„åŒºåˆ«

ç›¸åŒç‚¹
+ åŠ è½½æ–‡ä»¶æ—¶ä¸é˜»å¡é¡µé¢æ¸²æŸ“
+ ä½¿ç”¨è¿™ä¸¤ä¸ªå±æ€§çš„è„šæœ¬ä¸­ä¸èƒ½è°ƒç”¨document.writeæ–¹æ³•
+ æœ‰è„šæœ¬çš„onloadçš„äº‹ä»¶å›è°ƒ

ä¸åŒç‚¹

```js
JSå¼•æ“è¿›è¡Œè¯æ³•åˆ†ææ„å»ºDOMæ ‘ï¼Œåˆ°scriptçš„æ—¶å€™ä¼šåœä¸‹æ¥å»åŠ è½½JSä»£ç ï¼Œasyncå°±æ˜¯åœ¨DOMè§£æè¿‡ç¨‹å¼‚æ­¥åŠ è½½js,åŠ è½½å®Œå°±æ‰§è¡Œï¼Œè€Œdeferè¦ç­‰DOMè§£æå®Œæˆåï¼Œå†å»ä¸‹è½½ï¼Œå¦‚æœjsæœ‰å‰åä¾èµ–æ€§åº”è¯¥ä½¿ç”¨defer
```

# 2.JS å¼‚æ­¥è§£å†³æ–¹æ¡ˆçš„å‘å±•å†ç¨‹ä»¥åŠä¼˜ç¼ºç‚¹ã€‚

å¼‚æ­¥ç¼–ç¨‹çš„è¯­æ³•ç›®æ ‡ï¼Œå°±æ˜¯æ€æ ·è®©å®ƒæ›´åƒåŒæ­¥ç¼–ç¨‹ã€‚
ä¸»è¦æ–¹å¼ï¼š

+ å›è°ƒå‡½æ•°
+ äº‹ä»¶ç›‘å¬
+ å‘å¸ƒ/è®¢é˜…
+ Promise

+ Generator

## 1.å¹¶å‘å’Œå¹¶è¡ŒåŒºåˆ«

> å¹¶å‘ï¼šå®è§‚ä¸ŠåŒæ—¶å®Œæˆä»»åŠ¡ï¼Œå®è´¨ä¸Šæ˜¯é€šè¿‡ä»»åŠ¡ä¹‹é—´çš„åˆ‡æ¢å®Œæˆçš„

> å¹¶è¡Œï¼šå®é™…ä¸Šå°±æ˜¯åŒæ—¶å®Œæˆå¤šä¸ªä»»åŠ¡

## 2.å›è°ƒå‡½æ•°ï¼ˆcallbackï¼‰


```js
ajax('XXX1', () => {
    // callback å‡½æ•°ä½“
    ajax('XXX2', () => {
        // callback å‡½æ•°ä½“
        ajax('XXX3', () => {
            // callback å‡½æ•°ä½“
        })
    })
})
```
ä¼˜ç‚¹ï¼šè§£å†³äº†åŒæ­¥çš„é—®é¢˜, å¿…é¡»æŒ¨ä¸ªæ’é˜Ÿæ‰§è¡Œ

ç¼ºç‚¹ï¼š

+ å›è°ƒåœ°ç‹±,éœ€è¦è‡ªå·±å»ç†æ¸…æ¥šæ‰§è¡Œé¡ºåº
+ å›è°ƒæ˜¯å¦æ‰§è¡Œï¼Œæ‰§è¡Œäº†å¤šå°‘æ¬¡,æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œçš„éš¾ä»¥åˆ¤æ–­(å†…éƒ¨æ··æ‚äº†åŒæ­¥å¼‚æ­¥çš„å‡½æ•°ï¼Œæ¯”å¦‚å¦‚æœæœ‰ç¼“å­˜ï¼Œæ‰§è¡ŒåŒæ­¥ï¼Œæ²¡æœ‰ç¼“å­˜å°±å»è¯·æ±‚ï¼Œæ‰§è¡Œå¼‚æ­¥ï¼Œæ··æ‚å‘å¤–åªæš´éœ²ä¸€ä¸ªæ¥å£)
+ é”™è¯¯éš¾ä»¥è·å–ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨try...catch(å› ä¸ºå¼‚æ­¥æ“ä½œï¼Œåªæœ‰ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œéš¾ä»¥å¯»æ‰¾é”™è¯¯)
+ ä¸èƒ½ç›´æ¥returnæŠŠæ‰§è¡Œç»“æœç»™å¤–å±‚ï¼Œ å› ä¸ºæ¯ä¸€æ¬¡åªä¼šæŠŠæ‰§è¡Œç»“æœç»™è°ƒç”¨çš„å‡½æ•°ï¼Œ å›è°ƒå‡½æ•°å®é™…ä¸Šåªæœ‰æœ€å†…å±‚èƒ½æ‹¿åˆ°æœ€ç»ˆçš„ç»“æœ

## 3.Promise

Promiseå°±æ˜¯ä¸ºäº†è§£å†³callbackçš„é—®é¢˜è€Œäº§ç”Ÿçš„ã€‚å®ç°äº†é“¾å¼è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ then åè¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªå…¨æ–° Promiseï¼Œå¦‚æœæˆ‘ä»¬åœ¨ then ä¸­ return ï¼Œreturn çš„ç»“æœä¼šè¢« Promise.resolve() åŒ…è£…

```js
ajax('XXX1')
  .then(res => {
      // æ“ä½œé€»è¾‘
      return ajax('XXX2')
  }).then(res => {
      // æ“ä½œé€»è¾‘
      return ajax('XXX3')
  }).then(res => {
      // æ“ä½œé€»è¾‘
  })
```
ä¼˜ç‚¹ï¼šè§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜

ç¼ºç‚¹ï¼š

+ æ— æ³•æ•è·é”™è¯¯

```js
// promiseçš„ä¼ å‚åº”è¯¥æ˜¯resolveå’Œrejectä¸¤ä¸ªå‡½æ•°ï¼Œ ä¼ é€’nullä¼šæœ‰è¯­æ³•é”™è¯¯ï¼Œä»£ç åœæ­¢è¿è¡Œï¼Œä¸èƒ½æ‰“å°233333
const promise = new Promise(null);
console.log(233333);
// promiseå†…éƒ¨äº§ç”Ÿé”™è¯¯ï¼Œä¼šä¼ é€’ç»™é»˜è®¤çš„rejectå‡½æ•°ï¼Œ promiseçŠ¶æ€å˜ä¸ºrejected, é€šè¿‡ä¸‹ä¸€æ­¥çš„thenæˆ–è€…catchæ•è·ï¼Œ ä½†æ˜¯æ²¡æœ‰æä¾›çš„è¯å°±ä¼šç»§ç»­æ‰§è¡Œï¼Œæ‰“å°2333333
let promise = new Promise(() => {
    throw new Error('error')
});
console.log(2333333);
```

+ å•ä¸€å€¼

```js
//æ¯æ¬¡å‘thenä¼ é€’çš„éƒ½ä¸ºå•ä¸€çš„å€¼ï¼Œpromise.allæœ‰ä¸¤ä¸ªpromiseå¯¹è±¡ï¼Œ ç»™thençš„åªèƒ½æ˜¯ä¸€ä¸ªæ•°ç»„
Promise.all([Promise.resolve(1), Promise.resolve(2)])
.then(([x, y]) => {
    console.log(x, y);
});
```

+ æ— æ³•å–æ¶ˆ

```
ä¸€æ—¦å¼€å§‹ï¼Œæ— æ³•å–æ¶ˆ
```



## 4.Generator

+ ç‰¹ç‚¹ï¼šç”Ÿæˆå™¨ï¼Œå¯ä»¥è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œå¯ä»¥æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œ, åœ¨å‡½æ•°çš„æŸäº›éƒ¨åˆ†åœæ­¢, å¯ä»¥é…åˆ co å‡½æ•°åº“ä½¿ç”¨, 

```js
function* helloWorldGenerator() {
  yield 'hello';
  yield 'world';
  return 'ending';
}

var hw = helloWorldGenerator();
```

```JS
hw.next()// { value: 'hello', done: false }
hw.next()// { value: 'world', done: false }
hw.next()// { value: 'ending', done: true }
hw.next()// { value: undefined, done: true }
```

`Generatorå‡½æ•°`è¢«è°ƒç”¨æ—¶å¹¶ä¸ä¼šæ‰§è¡Œï¼Œåªæœ‰å½“è°ƒç”¨nextæ–¹æ³•æ—¶æ‰ä¼šæ‰§è¡Œ, å³å‡½æ•°å¯ä»¥æš‚åœï¼Œä¹Ÿå¯ä»¥æ¢å¤æ‰§è¡Œã€‚

æ¯æ¬¡è°ƒç”¨éå†å™¨å¯¹è±¡çš„nextæ–¹æ³•ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªæœ‰ç€valueå’Œ`done`ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ã€‚`value`å±æ€§è¡¨ç¤ºå½“å‰çš„å†…éƒ¨çŠ¶æ€çš„å€¼ï¼Œæ˜¯yieldè¡¨è¾¾å¼åé¢é‚£ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼›`done`å±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éå†ç»“æŸã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹

+ å…³é”®å­—yieldæ¥å®ç°è°ƒç”¨å¦å¤–çš„Generatorå‡½æ•°ã€‚å¦‚æœä¸€ä¸ªGeneratorå‡½æ•°Aæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿›å…¥ï¼ˆè°ƒç”¨ï¼‰äº†å¦ä¸€ä¸ªGeneratorå‡½æ•°Bï¼Œé‚£ä¹ˆä¼šä¸€ç›´ç­‰åˆ°Generatorå‡½æ•°Bå…¨éƒ¨æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šè¿”å›Generatorå‡½æ•°Aç»§ç»­æ‰§è¡Œã€‚

```js
function *foo(x) { 
  let y = 2 * (yield (x + 1)) 
  let z = yield (y / 3) 
  return (x + y + z) 
}
let it = foo(5)
console.log(it.next())   // => {value: 6, done: false}
console.log(it.next(12)) // => {value: 8, done: false}
console.log(it.next(13)) // => {value: 42, done: true}
```

+ ç¬¬ä¸€æ¬¡è°ƒç”¨next, ç¬¬ä¸€ä¸ª `yield` è¯­å¥ `(x + 1)` å°† `x` å¢åŠ 1
+ ç¬¬äºŒæ¬¡è°ƒç”¨nextï¼Œyieldè¾“å…¥å‚æ•°12ï¼Œä¼šèµ‹å€¼ç»™ç¬¬ä¸€ä¸ªyieldå¤„ï¼Œ åˆ™y=2*12ï¼Œåœåœ¨yield (y / 3) ï¼Œä¹Ÿå°±æ˜¯24/3=8
+ ç¬¬ä¸‰æ¬¡è°ƒç”¨next, ç¬¬äºŒä¸ªyieldèµ‹å€¼13ï¼Œ åˆ™z=13ï¼Œy=24,x=5,å’Œä¸º42

## 5.Async/await

asyncã€await æ˜¯å¼‚æ­¥çš„ç»ˆæè§£å†³æ–¹æ¡ˆ, 

ä¼˜ç‚¹ï¼š

+ ä»£ç æ¸…æ™°ï¼Œä¸ç”¨åƒ Promise å†™ä¸€å¤§å † then é“¾ï¼Œå¤„ç†äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜
+  å¯ä»¥è¢«try,catchæ•è·

ç¼ºç‚¹ï¼šawait å°†å¼‚æ­¥ä»£ç æ”¹é€ æˆåŒæ­¥ä»£ç ï¼Œå¦‚æœ**å¤šä¸ªå¼‚æ­¥æ“ä½œæ²¡æœ‰ä¾èµ–æ€§**è€Œä½¿ç”¨ await ä¼šå¯¼è‡´æ€§èƒ½ä¸Šçš„é™ä½ã€‚


```js
async function test() {
  // ä»¥ä¸‹ä»£ç æ²¡æœ‰ä¾èµ–æ€§çš„è¯ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨ Promise.all çš„æ–¹å¼
  // å¦‚æœæœ‰ä¾èµ–æ€§çš„è¯ï¼Œå…¶å®å°±æ˜¯è§£å†³å›è°ƒåœ°ç‹±çš„ä¾‹å­äº†
  await fetch('XXX1')
  await fetch('XXX2')
  await fetch('XXX3')
}
```
+ setTimeoutã€Promiseã€Async/Await çš„åŒºåˆ«

  + settimeoutçš„å›è°ƒå‡½æ•°æ”¾åˆ°å®ä»»åŠ¡é˜Ÿåˆ—é‡Œ
  + promise.thené‡Œçš„å›è°ƒå‡½æ•°ä¼šæ”¾åˆ°ç›¸åº”å®ä»»åŠ¡çš„å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼›
  + asyncå‡½æ•°è¡¨ç¤ºå‡½æ•°é‡Œé¢å¯èƒ½ä¼šæœ‰å¼‚æ­¥æ–¹æ³•ï¼Œawaitåé¢è·Ÿä¸€ä¸ªè¡¨è¾¾å¼ï¼Œasyncæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œé‡åˆ°awaitä¼šç«‹å³æ‰§è¡Œè¡¨è¾¾å¼ï¼Œç„¶åæŠŠè¡¨è¾¾å¼åé¢çš„ä»£ç æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œ

### å®ç°åŸç†

async æ˜¯Generatorå‡½æ•°çš„è¯­æ³•, å¹¶è¿›è¡Œäº†æ”¹è¿›ï¼Œ asyncå‡½æ•°å°±æ˜¯å°† Generator å‡½æ•°çš„æ˜Ÿå·ï¼ˆ*ï¼‰æ›¿æ¢æˆasyncï¼Œå°†yieldæ›¿æ¢æˆawait

æ”¹è¿›çš„éƒ¨åˆ†ï¼š

+ æ— éœ€æ‰‹åŠ¨æ‰§è¡Œ next() æ–¹æ³•
+ è¯­ä¹‰æ›´å¥½ç†è§£
+ async å‡½æ•°è¿”å›å€¼æ˜¯ Promise å¯¹è±¡





***************************
# promise

## 1.PromiseåŸºæœ¬ä½¿ç”¨

è§£å†³å›è°ƒçš„éƒ¨åˆ†é—®é¢˜
+ å›è°ƒæ‰§è¡Œå¤šæ¬¡===> Promiseçš„resolveåªèƒ½æ‰§è¡Œä¸€æ¬¡
+ å›è°ƒå‡½æ•°æœ‰æ²¡æœ‰æ‰§è¡Œ===> Promise.race
+ æ— æ³•åˆ¤å®šå›è°ƒæ˜¯å¦è¢«æ‰§è¡Œ==>thené‡Œè§„å®šäº†å¼‚æ­¥æ‰§è¡Œé¡ºåº

```js
new Promise((resolve, reject) => {
  resolve('success')
  // æ— æ•ˆ
  reject('reject')
})
```

### catch

+ æ•è·thençš„å‰ä¸€æ­¥é‡Œçš„é”™è¯¯ï¼Œthençš„rejectå’Œcatchä½œç”¨ç›¸åŒ
+ æ•è·thené‡Œçš„é”™è¯¯ï¼Œéœ€è¦åœ¨ä¸‹ä¸€ä¸ªthenæˆ–è€…catché‡Œ

```js
somethingAsync.then(function() {
    return somethingElseAsync()
}).then(null, function(err) {
    handleMyError(err);
});
æˆ–è€…
somethingAsync().then(function() {
    return somethingElseAsync();
}).catch(function(err) {
    handleMyError(err);
});

```

### promise.then

promiseçš„thenï¼Œå¦‚æœæœ‰returnï¼Œä¼šè¢«promise.resolveåŒ…è£¹ï¼Œè¿”å›ä¾ç„¶ä¸ºpromise

### promise.all

åªæœ‰å…¨éƒ¨éƒ½æ‰§è¡Œæ‰èƒ½æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼Œå¦‚æœp1,p2,p3éƒ½æ‰§è¡Œresolveï¼Œé‚£ä¹ˆç»“æœä¸º[1,2,3],å¦‚æœæŠŠp2æ”¹ä¸ºreject(2),é‚£ä¹ˆæ‰§è¡Œç»“æœä¸º2

```js
const p1 = new Promise((resolve, reject) => {
    resolve(1);
});
const p2 = new Promise((resolve, reject) => {
    resolve(2);
});
const p3 = new Promise((resolve, reject) => {
    resolve(3);
});

Promise.all([p1, p2, p3]).then(data => { 
    console.log(data); // [1, 2, 3] ç»“æœé¡ºåºå’Œpromiseå®ä¾‹æ•°ç»„é¡ºåºæ˜¯ä¸€è‡´çš„
}, err => {
    console.log(err);
});
```

### Promise.race

åªè¦æœ‰ä¸€ä¸ªä¸ºrejectedæˆ–è€…resolvedå°±æ‰§è¡Œåç»­æ“ä½œ

```js
function timerPromisefy(delay) {
    return new Promise(function (resolve, reject) {
        setTimeout(function () {
            resolve(delay);
        }, delay);
    });
}
var startDate = Date.now();

Promise.race([
    timerPromisefy(10),
    timerPromisefy(20),
    timerPromisefy(30)
]).then(function (values) {
    console.log(values); // 10
});
```

## 2.å¦‚ä½•ä¸­æ–­promiseçš„æ‰§è¡Œ

### ç¬¬ä¸€ä¸ªthenå¼ºè¡ŒæŠ¥é”™

ä¸€ç§æ–¹æ³•æ˜¯åœ¨then 1ä¸­ç›´æ¥æŠ›é”™, è¿™æ ·å°±ä¸ä¼šæ‰§è¡Œthen 2, then 3, ç›´æ¥è·³åˆ°catchæ–¹æ³•æ‰“å°err(ä½†æ­¤æ–¹æ³•å¹¶æ²¡æœ‰å®é™…ä¸­æ–­)

```js
Promise.resolve().then(() => {
    console.log('then 1')
    throw new Error('xxx')
}).then(() => {
    console.log('then 2')
}).then(() => {
    console.log('then 3')
}).catch((err) => {
    console.log(err)
})
```
### then 1ä¸­return ä¸€ä¸ªæ–°çš„Promise

åœ¨then 1ä¸­return ä¸€ä¸ªæ–°çš„Promise,ä½†ä¸æ”¹å˜å…¶çŠ¶æ€,è¿™æ ·è¯¥Promiseå°±ä¸€ç›´å¤„äºpeddingçŠ¶æ€,å³ä¸ä¼šæ‰§è¡Œåé¢ä»»ä½•æ–¹æ³•ï¼Œå› ä¸ºPromises/A+æ ‡å‡†ï¼šåŸPromiseå¯¹è±¡çš„çŠ¶æ€å°†è·Ÿæ–°å¯¹è±¡ä¿æŒä¸€è‡´ã€‚


```js
Promise.resolve().then(() => {
    console.log('then 1')
    return new Promise(() => {})
}).then(() => {
    console.log('then 2')
}).then(() => {
    console.log('then 3')
}).catch((err) => {
    console.log(err)
})
```
### Promise.raceç«é€Ÿæ–¹æ³•

è®©å…¶å®ƒä¸æ‰§è¡Œ

```js
let p1 = new Promise((resolve, reject) => {
    resolve('ok1')
})
 
let p2 = new Promise((resolve, reject) => {
    setTimeout(() => {resolve('ok2')}, 10)
})
 
Promise.race([p2, p1]).then((result) => {
    console.log(result) //ok1
}).catch((error) => {
    console.log(error)
})
```



## 3.æ‰‹å†™Promise

promiseç¿»è¯‘æ˜¯æ‰¿è¯ºï¼Œå®ƒæœ‰ä¸‰ç§çŠ¶æ€ï¼ŒçŠ¶æ€åªèƒ½ä»pendingå˜ä¸ºresolvedæˆ–è€…rejected
+ pending ç­‰å¾…ä¸­
+ fulfilledå·²æ‰§è¡Œ
+ rejected å·²æ‹’ç»

### åŸºæœ¬Promise

```js
var peomise1=new Mypromise((resolve,reject)=>{
    resolve(100)
    // pendingå˜ä¸ºäº†resolvedï¼Œ ä¸èƒ½å†æ‰§è¡Œrejectäº†
    reject(200)
})

// å®šä¹‰promiseçš„ä¸‰ç§çŠ¶æ€
const PENDING='pending'
const RESOLVED='resolved'
const REJECTED='rejected'
function Mypromise(fn){
    const that = this
    that.state= PENDING  // åˆå§‹çŠ¶æ€
    that.resolvedcallback=[] // æˆåŠŸçŠ¶æ€ä¸‹çš„å›è°ƒå‡½æ•°
    that.rejectedcallback=[] // å¤±è´¥çŠ¶æ€ä¸‹çš„å›è°ƒå‡½æ•°
    that.value=null // ç”¨äºå­˜å‚¨ä¼ å…¥çš„å€¼

    function resolve(value){
        if(that.state=== PENDING){
            that.state=RESOLVED
            that.value=value
         that.resolvedcallback.map((cb)=>cb(that.value)}
        console.log('resolve',that.value)
    }
    function reject(value){
        if(that.state === PENDING){
            that.state=REJECTED
            that.value=value           that.rejectedcallback.map((cb)=>cb(that.value))
        }
        console.log('reject',that.value)
    }            
    try{
        fn(resolve,reject)
    }catch(e){
        reject(e)
    }
}
```
+ then

```js
è§‚å¯Ÿè€…æ¨¡å¼
thenæ”¶é›†ä¾èµ–ï¼Œæ”¾å…¥å›è°ƒå‡½æ•°æ•°ç»„é‡Œ ->å¼‚æ­¥è§¦å‘resolve -> resolveæ‰§è¡Œä¾èµ–
```


```js
Mypromise.prototype.then=function(onfullfilled,onrejected){
    const that =this
    if(that.state===PENDING){
        that.resolvedcallback.push(onfullfilled)
        that.rejectedcallback.push(onrejected)
    }
    if(that.state===RESOLVED){
        onfullfilled(that.value)
    }
    if(that.state===REJECTED){
        onrejected(that.value)
    }
}

var peomise1=new Mypromise((resolve,reject)=>{
    resolve(100)
    reject(200)
}).then(data=>{console.log(data)})
```

### åŸºç¡€promiseæ”¹é€ 

#### resolveå’Œrejectå‡½æ•°

ä½œç”¨ï¼š ä¿®æ”¹stateçŠ¶æ€ï¼Œæ‰§è¡Œæœé›†åˆ°çš„å›è°ƒå‡½æ•°

+ æ”¹é€ resolveå’Œrejectå‡½æ•°ï¼Œresolveåˆ¤æ–­æ˜¯å¦ä¸ºpromiseç±»å‹ï¼Œæ˜¯åˆ™æ‰§è¡Œthen
+ resolveå’Œrejectç”¨setTimeoutåŒ…è£¹

```js
//resolveå‡½æ•°
function resolve(value) {
  //resolveåˆ¤æ–­æ˜¯å¦ä¸ºpromiseç±»å‹ï¼Œæ˜¯åˆ™æ‰§è¡Œthen
  if (value instanceof MyPromise) {
      return value.then(resolve, reject) 
   } 
   setTimeout(()=>{//ä¿è¯æ‰§è¡Œé¡ºåº
        //åªæœ‰çŠ¶æ€ä¸ºç­‰å¾…ä¸­æ‰å¯ä»¥è¿›è¡ŒçŠ¶æ€æ”¹å˜å¹¶éå†å›è°ƒå‡½æ•°æ•°ç»„
        if (that.state === PENDING) { 
            that.state = RESOLVED 
            that.value = value 
            that.resolvedCallbacks.map(cb => cb(that.value))
            console.log('resolve',value)
        }
       },0)
     } 

//rejectå‡½æ•°
function reject(value) { 
  setTimeout(()=>{
    if (that.state === PENDING) {
      that.state = REJECTED 
      that.value = value 
      that.rejectedCallbacks.map(cb => cb(that.value))
    }
  },0)
} 
```

#### then

+ thenéœ€è¦æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œthenè¿”å›çš„å€¼éœ€è¦è¢«åŒ…è£¹ä¸ºpromiseå½¢å¼ï¼Œæ‰èƒ½ç»§ç»­è°ƒç”¨thenæ–¹æ³•

```js
if (that.state === PENDING) { 
  // that.resolvedCallbacks.push(onFulfilled) 
  return ( promise2 = new MyPromise((resolve, reject) => { 
    that.resolvedCallbacks.push(() => { 
        try { 
            const x = onFulfilled(that.value) 
            resolutionProcedure(promise2, x, resolve, reject)
         } catch (r) { 
              reject(r) 
         } 
     }) 
  // that.rejectedCallbacks.push(onRejected) 
     that.rejectedCallbacks.push(() => { 
        try { 
            const x = onRejected(that.value)
            resolutionProcedure(promise2, x, resolve, reject)
            } catch (r) { 
              reject(r) 
           } 
      }) 
   }))
    console.log('then pending')
} 
```

####  promiseçŠ¶æ€é€ä¼ 

promise A+è§„å®š thenæ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªpromiseå®ä¾‹ï¼Œ åœ¨ Promise é“¾ä¸­ï¼Œå¦‚æœæŸä¸ª Promise æ²¡æœ‰ç»‘å®šç›¸åº”çš„å›è°ƒå‡½æ•°ï¼ˆonFulfilled æˆ– onRejectedï¼‰ï¼Œé‚£ä¹ˆå®ƒä¼šå°†çŠ¶æ€å’Œå€¼æˆ–åŸå› ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Promiseï¼Œä»¥ç¡®ä¿é”™è¯¯ä¸è¢«é™é»˜ä¸¢å¼ƒï¼Œ å¯ä»¥è¢«æ•è·å’Œå¤„ç†ã€‚

thenå¾—åˆ°çš„å€¼éœ€è¦è¿›ä¸€æ­¥ç»Ÿä¸€å¤„ç†ï¼Œå®ç°å…¼å®¹å¤šç§ Promise çš„ resolutionProcedure å‡½æ•°

```js
// promise2,thençš„æˆ‘ä»¬éœ€è¦çš„è¿”å›ï¼Œxä¸ºthenæ‰§è¡ŒonFulfilledæˆ–onRejectedè¿”å›å€¼ï¼Œå¯èƒ½æ˜¯æ™®é€šå€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯promise
//resolve,rejectä¸ºpromise2çš„å¯¹åº”resolveå’Œreject
function resolutionProcedure(promise2, x, resolve, reject) { 
    if (promise2 === x) { 
        return reject(new TypeError('Error')) 
    } 
}
//é¿å…å·¡å›å¼•ç”¨é—®é¢˜ï¼Œpromise2ä¸xä¸èƒ½ç›¸ç­‰
let p = new MyPromise((resolve, reject) => { 
resolve(1)
})
let p1 = p.then(value => { return p1})
```

+ è¿›ä¸€æ­¥åˆ¤æ–­xçš„ç±»å‹
+ å¦‚æœxä¸ºæ™®é€šå€¼ï¼Œç›´æ¥resolve
+ å¦‚æœxä¸ºpromiseï¼Œé‚£ä¹ˆå®ƒå¿…ç„¶æœ‰ä¸€ä¸ªthenæ–¹æ³•ï¼Œåˆ¤æ–­x.thençš„ç±»å‹ï¼Œå¦‚æœæ˜¯æ™®é€šå€¼ï¼ˆthené“¾ç»“æŸï¼‰ï¼Œresolveå¤„ç†ï¼Œå¦‚æœä¸ºfunctionï¼Œé‚£ä¹ˆè°ƒç”¨å®ƒçš„thenæ–¹æ³•ï¼Œå¹¶æ”¹å˜è°ƒç”¨æ¬¡æ•°çš„å€¼ï¼Œç„¶åé€’å½’è°ƒç”¨ï¼Œç›´åˆ°æœ€ç»ˆæˆä¸ºä¸€ä¸ªæ™®é€šå€¼

```js
function resolutionProcedure(promise2, x, resolve, reject) { 
    if (promise2 === x) { 
        return reject(new TypeError('Error')) 
    } 
   //é¦–å…ˆåˆ›å»ºä¸€ä¸ªå˜é‡ called ç”¨äºåˆ¤æ–­æ˜¯å¦å·²ç»è°ƒç”¨è¿‡å‡½æ•°
    let called = false
    //åˆ¤æ–­ä¸ºæ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡ï¼ˆpromiseï¼‰
    if (x !== null && (typeof x === 'object' || typeof x === 'function')) { 
         try { 
            let then = x.then //åˆ¤æ–­ç±»å‹
            if (typeof then === 'function') { //åˆ¤æ–­å¾—åˆ°x.thenä¸ºå‡½æ•°ï¼Œè¯´æ˜å®ƒæ˜¯promiseé‡Œçš„thenæ–¹æ³•, 
              //ä½¿ç”¨x.thenæ–¹æ³•
                then.call(  x, y => { 
                  //å¦‚æœå·²ç»è°ƒç”¨è¿‡ï¼Œç›´æ¥è¿”å›
                  if (called) return 
                  //æ²¡æœ‰è°ƒç”¨è¿‡ï¼Œæ ‡è®°ä¸ºè°ƒç”¨è¿‡
                   called = true 
                  //ç”±äºæˆåŠŸçš„è¿”å›yè¿˜å¯èƒ½æ˜¯promiseï¼Œæ‰€ä»¥éœ€è¦é€’å½’
                  resolutionProcedure(promise2, y, resolve, reject) 
                 }, e => {  
                     if (called) return 
                          called = true 
                          reject(e) 
                 }) 
              //åˆ¤æ–­å¾—åˆ°x.thenä¸ä¸ºå‡½æ•°ï¼Œç›´æ¥resolve
             } else { 
                resolve(x)
             } 
         } catch (e) { 
             if (called) return 
             called = true 
             reject(e) 
           } 
    } else { 
      //ä¸æ˜¯å¯¹è±¡æˆ–è€…å‡½æ•°ï¼ˆä¸æ˜¯promiseï¼Œå€¼ç›´æ¥ä¼ å…¥resolveä¸­ï¼‰
       resolve(x) 
    } 
}
```



### Promise A+

```js
// å®šä¹‰promiseçš„ä¸‰ç§çŠ¶æ€
const PENDING='pending'
const RESOLVED='resolved'
const REJECTED='rejected'

// è‡ªå®šä¹‰promiseï¼Œ æ¥æ”¶fnä½œä¸ºå‚æ•°ï¼Œ fn åŒ…å«ä¸¤ä¸ªå‚æ•° resolve å’Œ rejectï¼Œåˆ†åˆ«ç”¨äºåœ¨å¼‚æ­¥æ“ä½œæˆåŠŸæˆ–å¤±è´¥æ—¶æ”¹å˜ Promise çš„çŠ¶æ€ã€‚
function MyPromise(fn){
   const that = this
   that.state= PENDING        // åˆå§‹çŠ¶æ€
   that.resolvedCallbacks=[]  // æˆåŠŸå›è°ƒæ•°ç»„
   that.rejectedCallbacks=[]  // å¤±è´¥å›è°ƒæ•°ç»„
   that.value=null
  
  // resolveå‡½æ•°ï¼šç”¨äºæ”¹å˜çŠ¶æ€ä»¥åŠä¿è¯å›è°ƒå‡½æ•°æ‰§è¡Œ
  function resolve(value) { 
    if (value instanceof MyPromise) { //å€¼å¿…é¡»æ˜¯promiseï¼Œ æ‰§è¡Œthenæœé›†æˆåŠŸçš„æ¯æ‰å‡½æ•°
      return value.then(resolve, reject) 
    } 
    setTimeout(()=>{//ä¿è¯æ‰§è¡Œé¡ºåº
      if (that.state === PENDING) { 
        //åªæœ‰çŠ¶æ€ä¸ºç­‰å¾…ä¸­æ‰å¯ä»¥è¿›è¡ŒçŠ¶æ€æ”¹å˜å¹¶éå†å›è°ƒå‡½æ•°æ•°ç»„
        that.state = RESOLVED 
        that.value = value 
      }
    },0)
  } 
  //rejectå‡½æ•°ï¼šç”¨äºæ”¹å˜çŠ¶æ€ä»¥åŠä¿è¯å›è°ƒå‡½æ•°æ‰§è¡Œ
  function reject(value) { 
    setTimeout(()=>{
      if (that.state === PENDING) {
        that.state = REJECTED 
        that.value = value 
        that.rejectedCallbacks.map(cb => cb(that.value))
      }
    },0)
  } 
  
  try{
    fn(resolve,reject)
  }catch(e){
    reject(e)
  }
}

// then æœé›†å›è°ƒå‡½æ•°
MyPromise.prototype.then=function(onFulfilled,onRejected){
    const that =this
    onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : v => v 
    onRejected = typeof onRejected === 'function' ? onRejected : r => {throw r } 
    if (that.state === PENDING) { 
     // that.resolvedCallbacks.push(onFulfilled) 
     return ( promise2 = new MyPromise((resolve, reject) => { 
        that.resolvedCallbacks.push(() => { 
                try { 
                    const x = onFulfilled(that.value) 
                    resolutionProcedure(promise2, x, resolve, reject)
                  } catch (r) { 
                      reject(r) 
                  } 
        }) 
      // that.rejectedCallbacks.push(onRejected) 
         that.rejectedCallbacks.push(() => { 
              try { 
                  const x = onRejected(that.value)
                  resolutionProcedure(promise2, x, resolve, reject)
               } catch (r) { 
                  reject(r) 
               } 
           }) 
      }))
  } 
  
  //å¦‚æœçŠ¶æ€ä¸ºresolvedï¼Œæ‰§è¡Œå‡½æ•°
  if (that.state === RESOLVED) { 
     return (promise2 = new MyPromise((resolve, reject) => { 
       setTimeout(() => { 
          try { 
              const x = onFulfilled(that.value) 
              resolutionProcedure(promise2, x, resolve, reject) 
            } catch (reason) { 
                 reject(reason) 
             } 
         })
     })) 
  }

  // //å¦‚æœçŠ¶æ€ä¸ºrejectï¼Œæ‰§è¡Œå‡½æ•°
   if (that.state === REJECTED) { 
       return (promise2 = new MyPromise((resolve, reject) => { 
           setTimeout(() => { 
               try { 
                 const x = onRejected(that.value) 
                 resolutionProcedure(promise2, x, resolve, reject) 
                } catch (reason) { 
                    reject(reason) 
               } 
          })
      })) 
   }
 } 

// promise2,thençš„æˆ‘ä»¬éœ€è¦çš„è¿”å›ï¼Œxä¸ºthenæ‰§è¡ŒonFulfilledæˆ–onRejectedè¿”å›å€¼ï¼Œå¯èƒ½æ˜¯æ™®é€šå€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯promise
//resolve,rejectä¸ºpromise2çš„å¯¹åº”resolveå’Œreject

è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œç”¨äºå¤„ç† Promise çš„çŠ¶æ€é€ä¼ å’Œå€¼ä¼ é€’ã€‚å®ƒå¤„ç†äº†å„ç§æƒ…å†µï¼ŒåŒ…æ‹¬ Promise é“¾ä¸­çš„é€ä¼ ã€è¿”å› Promiseã€é”™è¯¯å¤„ç†ç­‰ã€‚è¿™ä¸ªå‡½æ•°ç¡®ä¿äº† Promise/A+ è§„èŒƒçš„è¦æ±‚ï¼ŒåŒ…æ‹¬çŠ¶æ€é€ä¼ å’Œé”™è¯¯å¤„ç†ã€‚

function resolutionProcedure(promise2, x, resolve, reject) { 
    if (promise2 === x) { 
        return reject(new TypeError('Error')) 
    } 
    //é¦–å…ˆåˆ›å»ºä¸€ä¸ªå˜é‡ called ç”¨äºåˆ¤æ–­æ˜¯å¦å·²ç»è°ƒç”¨è¿‡å‡½æ•°
    let called = false 
    //åˆ¤æ–­ä¸ºæ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡ï¼ˆpromiseï¼‰
    if (x !== null && (typeof x === 'object' || typeof x === 'function')) {
         try { 
            // åˆ¤æ–­å¾—åˆ°xä¸ºå‡½æ•°æˆ–è€…å¯¹è±¡ï¼ˆpromiseç±»å‹ï¼‰
            let then = x.then //åˆ¤æ–­ç±»å‹
            //åˆ¤æ–­å¾—åˆ°x.thenä¸ºå‡½æ•°ï¼Œè¯´æ˜å®ƒæ˜¯promiseé‡Œçš„thenæ–¹æ³•
            if (typeof then === 'function') { 
                then.call(  x, y => { //ä½¿ç”¨x.thenæ–¹æ³•
                   if (called) return //å¦‚æœå·²ç»è°ƒç”¨è¿‡ï¼Œç›´æ¥è¿”å›
                    called = true //æ²¡æœ‰è°ƒç”¨è¿‡ï¼Œæ ‡è®°ä¸ºè°ƒç”¨è¿‡
   //ç”±äºæˆåŠŸçš„è¿”å›yè¿˜å¯èƒ½æ˜¯promiseï¼Œæ‰€ä»¥éœ€è¦é€’å½’
                     resolutionProcedure(promise2, y, resolve, reject) 
                   }, e => {  
                       if (called) return 
                          called = true 
                          reject(e) 
                   }) 
             } else { //åˆ¤æ–­å¾—åˆ°x.thenä¸ä¸ºå‡½æ•°ï¼Œç›´æ¥resolve
                resolve(x)
             } 
         } catch (e) { 
             if (called) return 
             called = true 
             reject(e) 
             } 
    } else { //ä¸æ˜¯å¯¹è±¡æˆ–è€…å‡½æ•°ï¼ˆä¸æ˜¯promiseï¼Œå€¼ç›´æ¥ä¼ å…¥resolveä¸­ï¼‰
        resolve(x) 
    } 
}

const p1 = new MyPromise((resolve, reject) => {
  resolve(1)          //åŒæ­¥executoræµ‹è¯•
}).then(res => {
    console.log(res)
    return 2          //é“¾å¼è°ƒç”¨æµ‹è¯•
  })

  .then()             //å€¼ç©¿é€æµ‹è¯•
  .then(res => {
    console.log(res)
    return new MyPromise((resolve, reject) => {
      resolve(3)      //è¿”å›Promiseæµ‹è¯•
    })
  })
  .then(res => {
    console.log(res)
    throw new Error('rejectæµ‹è¯•')   //rejectæµ‹è¯•
  })
  .then(() => {}, err => {
    console.log(err)
  })
// 1 
// 2 
// 3 
// Error: rejectæµ‹è¯•
```

## 4.å®ç° promiseify æ–¹æ³•

ä½œç”¨ï¼šæŠŠå¼‚æ­¥å‡½æ•°è½¬æ¢ä¸ºpromise,ç›´æ¥å¯ä»¥ä½¿ç”¨then

```js
let Promise = require('./bluebird');
let fs = require("fs");

var readFile = Promise.promisify(fs.readFile);
readFile("1.txt", "utf8").then(function(data) {
    console.log(data);
})
```
å†™æ³•

+ è¿”å›ä¸€ä¸ªpromise
+ å†…éƒ¨å°†åŸæ¥å‚æ•°åé¢æ‹¼æ¥ä¸€ä¸ªå›è°ƒå‡½æ•°å‚æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°é‡Œæ‰§è¡Œè¿™ä¸ªpromiseçš„resloveæ–¹æ³•æŠŠç»“æœä¼ å‡ºå»ï¼Œpromiseifyå°±å®ç°äº†

```js
MyPromise.promisify = function(fn) {
    return function() {
        var args = Array.from(arguments);
        return new MyPromise(function(resolve, reject) {
            fn.apply(null, args.concat(function(err) {
                err ? reject(err) : resolve(arguments[1])
            }));
        })
    }
}
```
## 5.æ‰‹å†™raceæ–¹æ³•

+ **Promise.resolve(p)**ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
+ ç›´æ¥forEachå³å¯
```js
let race=function(arr){
  return new Promise((resolve,reject)=>{
    arr.forEach(item=>{
      //åŒæ—¶æ‰§è¡ŒPromise,å¦‚æœæœ‰ä¸€ä¸ªPromiseçš„çŠ¶æ€å‘ç”Ÿæ”¹å˜,å°±å˜æ›´æ–°MyPromiseçš„çŠ¶æ€
      Promise.resolve(item).then(resolve,reject)
    })
  })
}

let p1 = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve('success2')
    }, 1000)
})
let p2 = new Promise((resolve, reject) => {
    setTimeout(() => {
        reject('reject')
    }, 500)
})
// è°ƒç”¨
race([p1, p2]).then(res => {
    console.log(res);
}).catch(err => {
    console.error(err);
})
```

## 6.æ‰‹å†™allæ–¹æ³•

+ è¾“å…¥æ˜¯promiseæ•°ç»„ï¼Œ è¿”å›ä¹Ÿæ˜¯promise, å¹¶ä¸”ç»“æœæ˜¯ä¼ å…¥çš„promiseæ•°ç»„çš„ç»“æœ
+ å½“æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆæ—¶ï¼ŒPromise.all()è¿”å›resolveï¼Œä½†å½“æœ‰ä¸€ä¸ªå¤±è´¥(reject)ï¼Œåˆ™è¿”å›å¤±è´¥çš„ä¿¡æ¯ï¼Œå³ä½¿å…¶ä»–promiseæ‰§è¡ŒæˆåŠŸï¼Œä¹Ÿä¼šè¿”å›å¤±è´¥ã€‚
+ éœ€è¦å…ˆæŠŠæ‰€æœ‰æ–¹æ³•æœé›†åˆ°ä¸€ä¸ªæ•°ç»„é‡Œ
+ promise.resolve()åŒ…è£¹
```js
function promiseAll(promises) {
  return new Promise((resolve, reject) => {
    if (!Array.isArray(promises)) {
      reject(new TypeError('promises must be an array'));
      return;
    }

    const results = [];
    let completedPromises = 0;

    promises.forEach((promise, index) => {
      Promise.resolve(promise)
        .then((result) => {
          results[index] = result;
          completedPromises++;

          if (completedPromises === promises.length) {
            resolve(results);
          }
        })
        .catch(reject);
    });

    if (promises.length === 0) {
      resolve(results);
    }
  });
}

// ç¤ºä¾‹ä½¿ç”¨
const promise1 = Promise.resolve(1);
const promise2 = new Promise((resolve) => setTimeout(() => resolve(2), 1000));
const promise3 = Promise.reject('Error occurred');

promiseAll([promise1, promise2, promise3])
  .then((results) => console.log('All promises resolved:', results))
  .catch((error) => console.error('At least one promise rejected:', error));
```
## 7.æ‰‹å†™finally

finally()æ–¹æ³•è¿”å›ä¸€ä¸ªPromiseã€‚åœ¨promiseç»“æŸæ—¶ï¼Œæ— è®ºç»“æœæ˜¯fulfilledæˆ–è€…æ˜¯rejectedï¼Œéƒ½ä¼šæ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚åœ¨finallyä¹‹åï¼Œè¿˜å¯ä»¥ç»§ç»­thenã€‚å¹¶ä¸”ä¼šå°†å€¼åŸå°ä¸åŠ¨çš„ä¼ é€’ç»™åé¢çš„then

```js
Promise.prototype.finally = function (callback) {
  let P = this.constructor;
  return this.then(
    value  => P.resolve(callback()).then(() => value),
    reason => P.resolve(callback()).then(() => { throw reason })
  );
};
```

```
ä¸ºä»€ä¹ˆéœ€è¦Promise.resolve(callback()).then(() => value)
è€Œä¸èƒ½ç›´æ¥æ‰§è¡Œcallback, return value

å› ä¸ºcallbackå¦‚æœæ˜¯ä¸ªå¼‚æ­¥æ“ä½œï¼Œè¿”å›promiseå‘¢.å¸Œæœ›ç­‰callbackæ‰§è¡Œå®Œå†æ¥ç€æ‰§è¡Œ
```

## 8.catch,all,resolve,reject,race

```js
//catchæ–¹æ³•å…¶å®å°±æ˜¯æ‰§è¡Œä¸€ä¸‹thençš„ç¬¬äºŒä¸ªå›è°ƒ
catch(rejectFn) {
  return this.then(undefined, rejectFn)
}
```

```js
//é™æ€çš„resolveæ–¹æ³•
static resolve(value) {
  if(value instanceof MyPromise) return value // æ ¹æ®è§„èŒƒ, å¦‚æœå‚æ•°æ˜¯Promiseå®ä¾‹, ç›´æ¥returnè¿™ä¸ªå®ä¾‹
  return new MyPromise(resolve => resolve(value))
}
```

```js
//é™æ€çš„rejectæ–¹æ³•
static reject(reason) {
  return new MyPromise((resolve, reject) => reject(reason))
}
```

# asyncå‡½æ•°(spawnçš„å®ç°)

async å‡½æ•°å°±æ˜¯å°† Generator å‡½æ•°çš„æ˜Ÿå·ï¼ˆ*ï¼‰æ›¿æ¢æˆ asyncï¼Œå°† yield æ›¿æ¢æˆ awaitã€‚async å‡½æ•°çš„å®ç°ï¼Œå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚

```js

async function fn(args){
 // ...
}
// ç­‰åŒäº
function fn(args){ 
  return spawn(function*() {
    // ...
  }); 
}
```
spawnå‡½æ•°çš„å®ç°

```js
function spawn(genF) {
  return new Promise(function(resolve, reject) {
    var gen = genF();
    function step(nextF) {
      try {
        var next = nextF();
      } catch(e) {
        return reject(e); 
      }
      if(next.done) {
        return resolve(next.value);
      } 
      Promise.resolve(next.value).then(function(v) {
        step(function() { return gen.next(v); });      
      }, function(e) {
        step(function() { return gen.throw(e); });
      });
    }
    step(function() { return gen.next(undefined); });
  });
}
```


# asyncã€await ç»†èŠ‚

èµ„æ–™ï¼šhttps://juejin.cn/post/7194744938276323384#heading-1

## asyncçš„è¿”å›å€¼

`async`å‡½æ•°åœ¨æŠ›å‡ºè¿”å›å€¼æ—¶ï¼Œä¼šæ ¹æ®è¿”å›å€¼**ç±»å‹**å¼€å¯**ä¸åŒæ•°ç›®çš„å¾®ä»»åŠ¡**

- returnç»“æœå€¼ï¼šé`thenable`ã€é`promise`ï¼ˆä¸ç­‰å¾…ï¼‰
- returnç»“æœå€¼ï¼š`thenable`ï¼ˆç­‰å¾… 1ä¸ª`then`çš„æ—¶é—´ï¼‰
- returnç»“æœå€¼ï¼š`promise`ï¼ˆç­‰å¾… 2ä¸ª`then`çš„æ—¶é—´ï¼‰

```js
async function testC () {
Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  resolve()
Â  Â  })
} 

testC().then(() => console.log(1));
Promise.resolve()
Â  Â  .then(() => console.log(2))
Â  Â  .then(() => console.log(3))
Â  Â  .then(() => console.log(4))
// (ç­‰å¾…ä¸¤ä¸ªthen)æœ€ç»ˆç»“æœ: 2 3 1 4
```

## **await å³å€¼ç±»å‹åŒºåˆ«**

+ `await`åé¢æ¥é `thenable` ç±»å‹ï¼Œä¼šç«‹å³å‘å¾®ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡`then`ï¼Œ**ä½†ä¸éœ€ç­‰å¾…**
+ `await` åé¢æ¥ `thenable` ç±»å‹ï¼Œéœ€è¦**ç­‰å¾…ä¸€ä¸ª `then` çš„æ—¶é—´ä¹‹å**æ‰§è¡Œ
+ `await` åé¢æ¥ promise ç±»å‹ï¼Œ éœ€è¦**ç­‰å¾…ä¸€ä¸ª `then` çš„æ—¶é—´ä¹‹å**æ‰§è¡Œï¼ˆTC 39(ECMAScriptæ ‡å‡†åˆ¶å®šè€…) å¯¹`await` åé¢æ˜¯ `promise` çš„æƒ…å†µå¦‚ä½•å¤„ç†è¿›è¡Œäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œ**ç§»é™¤**äº†é¢å¤–çš„ä¸¤ä¸ªå¾®ä»»åŠ¡ï¼Œåœ¨**æ—©æœŸç‰ˆæœ¬**ï¼Œä¾ç„¶ä¼šç­‰å¾…ä¸¤ä¸ª `then` çš„æ—¶é—´ï¼‰
+  **å®Œå…¨å¯ä»¥å°† `await` åé¢çš„ä»£ç å¯ä»¥çœ‹åšåœ¨ `then` é‡Œé¢æ‰§è¡Œçš„ç»“æœ**

```js
function func () {
 Â  Â console.log(2);
}
async function test () {
 Â  Â console.log(1);
 Â  Â await func();
 Â  Â console.log(3);
}
test();
console.log(4);

// æœ€ç»ˆç»“æœğŸ‘‰: 1 2 4 3
```

## å…¶ä»–

`await`ä¸€å®šè¦ç­‰åˆ°å³ä¾§çš„è¡¨è¾¾å¼æœ‰**ç¡®åˆ‡çš„å€¼**æ‰ä¼šæ”¾è¡Œï¼Œå¦åˆ™å°†ä¸€ç›´ç­‰å¾…ï¼ˆé˜»å¡å½“å‰`async`å‡½æ•°å†…çš„åç»­ä»£ç ï¼‰

```js
function func () {
 Â  Â return new Promise((resolve) => {
 Â  Â  Â  Â console.log('B')
 Â  Â  Â  Â // resolve() æ•…æ„ä¸€ç›´ä¿æŒpending
 Â   })
}
async function test () {
 Â  Â console.log(1);
 Â  Â await func()
 Â  Â console.log(3);
}
test();
console.log(4);
// æœ€ç»ˆç»“æœğŸ‘‰: 1 B 4 (æ°¸è¿œä¸ä¼šæ‰“å°3)
```

