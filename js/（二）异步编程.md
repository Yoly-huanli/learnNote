[toc]

# JSåŸºç¡€
## å¼‚æ­¥åŠ è½½
### asyncå’Œdeferçš„åŒºåˆ«
ç›¸åŒç‚¹
+ åŠ è½½æ–‡ä»¶æ—¶ä¸é˜»å¡é¡µé¢æ¸²æŸ“
+ ä½¿ç”¨è¿™ä¸¤ä¸ªå±æ€§çš„è„šæœ¬ä¸­ä¸èƒ½è°ƒç”¨document.writeæ–¹æ³•
+ æœ‰è„šæœ¬çš„onloadçš„äº‹ä»¶å›è°ƒ

ä¸åŒç‚¹

```js
JSå¼•æ“è¿›è¡Œæ­¤æ³•åˆ†ææ„å»ºDOMæ ‘ï¼Œåˆ°scriptçš„æ—¶å€™ä¼šåœä¸‹æ¥å»åŠ è½½JSä»£ç ï¼Œasyncå°±æ˜¯åœ¨DOMè§£æè¿‡ç¨‹å¼‚æ­¥åŠ è½½js,åŠ è½½å®Œå°±æ‰§è¡Œï¼Œè€Œdeferè¦ç­‰DOMè§£æå®Œæˆåï¼Œå†å»ä¸‹è½½
```

+ å¯¹äºdeferï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯å°†å¤–é“¾çš„jsæ”¾åœ¨äº†é¡µé¢åº•éƒ¨ã€‚jsçš„åŠ è½½ä¸ä¼šé˜»å¡é¡µé¢çš„æ¸²æŸ“å’Œèµ„æºçš„åŠ è½½ã€‚ä¸è¿‡deferä¼šæŒ‰ç…§åŸæœ¬çš„jsçš„é¡ºåºæ‰§è¡Œï¼Œæ‰€ä»¥å¦‚æœå‰åæœ‰ä¾èµ–å…³ç³»çš„jså¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚
+ å¯¹äºasyncï¼Œè¿™ä¸ªæ˜¯html5ä¸­æ–°å¢çš„å±æ€§ï¼Œå®ƒçš„ä½œç”¨æ˜¯èƒ½å¤Ÿå¼‚æ­¥çš„åŠ è½½å’Œæ‰§è¡Œè„šæœ¬ï¼Œä¸å› ä¸ºåŠ è½½è„šæœ¬è€Œé˜»å¡é¡µé¢çš„åŠ è½½ã€‚ä¸€æ—¦åŠ è½½åˆ°å°±ä¼šç«‹åˆ»æ‰§è¡Œåœ¨æœ‰asyncçš„æƒ…å†µä¸‹ï¼Œjsä¸€æ—¦ä¸‹è½½å¥½äº†å°±ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥å¾ˆæœ‰å¯èƒ½ä¸æ˜¯æŒ‰ç…§åŸæœ¬çš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚å¦‚æœjså‰åæœ‰ä¾èµ–æ€§ï¼Œç”¨asyncï¼Œå°±å¾ˆæœ‰å¯èƒ½å‡ºé”™ã€‚

******
## JS å¼‚æ­¥è§£å†³æ–¹æ¡ˆçš„å‘å±•å†ç¨‹ä»¥åŠä¼˜ç¼ºç‚¹ã€‚
+ 1.å›è°ƒå‡½æ•°ï¼ˆcallbackï¼‰


```js
ajax('XXX1', () => {
    // callback å‡½æ•°ä½“
    ajax('XXX2', () => {
        // callback å‡½æ•°ä½“
        ajax('XXX3', () => {
            // callback å‡½æ•°ä½“
        })
    })
})
```
ä¼˜ç‚¹ï¼šè§£å†³äº†åŒæ­¥çš„é—®é¢˜ï¼ˆåªè¦æœ‰ä¸€ä¸ªä»»åŠ¡è€—æ—¶å¾ˆé•¿ï¼Œåé¢çš„ä»»åŠ¡éƒ½å¿…é¡»æ’é˜Ÿç­‰ç€ï¼Œä¼šæ‹–å»¶æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œã€‚ï¼‰

ç¼ºç‚¹ï¼šå›è°ƒåœ°ç‹±ï¼Œä¸èƒ½ç”¨ try catch æ•è·é”™è¯¯ï¼Œä¸èƒ½ returnï¼Œå›è°ƒåœ°ç‹±çš„æ ¹æœ¬é—®é¢˜åœ¨äºï¼š


```js
ç¼ºä¹é¡ºåºæ€§ï¼š å›è°ƒåœ°ç‹±å¯¼è‡´çš„è°ƒè¯•å›°éš¾ï¼Œå’Œå¤§è„‘çš„æ€ç»´æ–¹å¼ä¸ç¬¦
åµŒå¥—å‡½æ•°å­˜åœ¨è€¦åˆæ€§ï¼Œä¸€æ—¦æœ‰æ‰€æ”¹åŠ¨ï¼Œå°±ä¼šç‰µä¸€å‘è€ŒåŠ¨å…¨èº«
åµŒå¥—å‡½æ•°è¿‡å¤šçš„å¤šè¯ï¼Œå¾ˆéš¾å¤„ç†é”™è¯¯
```
+ 2.Promise

Promiseå°±æ˜¯ä¸ºäº†è§£å†³callbackçš„é—®é¢˜è€Œäº§ç”Ÿçš„ã€‚
Promise å®ç°äº†é“¾å¼è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ then åè¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªå…¨æ–° Promiseï¼Œå¦‚æœæˆ‘ä»¬åœ¨ then ä¸­ return ï¼Œreturn çš„ç»“æœä¼šè¢« Promise.resolve() åŒ…è£…


ä¼˜ç‚¹ï¼šè§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜

ç¼ºç‚¹ï¼šæ— æ³•å–æ¶ˆ Promise ï¼Œé”™è¯¯éœ€è¦é€šè¿‡å›è°ƒå‡½æ•°æ¥æ•è·

```js
ajax('XXX1')
  .then(res => {
      // æ“ä½œé€»è¾‘
      return ajax('XXX2')
  }).then(res => {
      // æ“ä½œé€»è¾‘
      return ajax('XXX3')
  }).then(res => {
      // æ“ä½œé€»è¾‘
  })
```
+ 3.Generator

ç‰¹ç‚¹ï¼šå¯ä»¥æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œï¼Œå¯ä»¥é…åˆ co å‡½æ•°åº“ä½¿ç”¨

```js
function *fetch() {
    yield ajax('XXX1', () => {})
    yield ajax('XXX2', () => {})
    yield ajax('XXX3', () => {})
}
let it = fetch()
let result1 = it.next()
let result2 = it.next()
let result3 = it.next()
```
+ 4.Async/await

asyncã€await æ˜¯å¼‚æ­¥çš„ç»ˆæè§£å†³æ–¹æ¡ˆ

ä¼˜ç‚¹æ˜¯ï¼šä»£ç æ¸…æ™°ï¼Œä¸ç”¨åƒ Promise å†™ä¸€å¤§å † then é“¾ï¼Œå¤„ç†äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜

ç¼ºç‚¹ï¼šawait å°†å¼‚æ­¥ä»£ç æ”¹é€ æˆåŒæ­¥ä»£ç ï¼Œå¦‚æœ**å¤šä¸ªå¼‚æ­¥æ“ä½œæ²¡æœ‰ä¾èµ–æ€§**è€Œä½¿ç”¨ await ä¼šå¯¼è‡´æ€§èƒ½ä¸Šçš„é™ä½ã€‚


```js
async function test() {
  // ä»¥ä¸‹ä»£ç æ²¡æœ‰ä¾èµ–æ€§çš„è¯ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨ Promise.all çš„æ–¹å¼
  // å¦‚æœæœ‰ä¾èµ–æ€§çš„è¯ï¼Œå…¶å®å°±æ˜¯è§£å†³å›è°ƒåœ°ç‹±çš„ä¾‹å­äº†
  await fetch('XXX1')
  await fetch('XXX2')
  await fetch('XXX3')
}
```
**********
## setTimeoutã€Promiseã€Async/Await çš„åŒºåˆ«
+ settimeoutçš„å›è°ƒå‡½æ•°æ”¾åˆ°å®ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œç­‰åˆ°æ‰§è¡Œæ ˆæ¸…ç©ºä»¥åæ‰§è¡Œï¼›
+ promise.thené‡Œçš„å›è°ƒå‡½æ•°ä¼šæ”¾åˆ°ç›¸åº”å®ä»»åŠ¡çš„å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œç­‰å®ä»»åŠ¡é‡Œé¢çš„åŒæ­¥ä»£ç æ‰§è¡Œå®Œå†æ‰§è¡Œï¼›
+ asyncå‡½æ•°è¡¨ç¤ºå‡½æ•°é‡Œé¢å¯èƒ½ä¼šæœ‰å¼‚æ­¥æ–¹æ³•ï¼Œawaitåé¢è·Ÿä¸€ä¸ªè¡¨è¾¾å¼ï¼Œasyncæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œé‡åˆ°awaitä¼šç«‹å³æ‰§è¡Œè¡¨è¾¾å¼ï¼Œç„¶åæŠŠè¡¨è¾¾å¼åé¢çš„ä»£ç æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œè®©å‡ºæ‰§è¡Œæ ˆè®©åŒæ­¥ä»£ç å…ˆæ‰§è¡Œã€‚
**********


## å¼‚æ­¥ç¼–ç¨‹
å¼‚æ­¥ç¼–ç¨‹çš„è¯­æ³•ç›®æ ‡ï¼Œå°±æ˜¯æ€æ ·è®©å®ƒæ›´åƒåŒæ­¥ç¼–ç¨‹ã€‚
ä¸»è¦æ–¹å¼ï¼š
+ å›è°ƒå‡½æ•°
+ äº‹ä»¶ç›‘å¬
+ å‘å¸ƒ/è®¢é˜…
+ Promise

+ Generator

### 1.å¹¶å‘å’Œå¹¶è¡ŒåŒºåˆ«
> å¹¶å‘ï¼šå®è§‚ä¸ŠåŒæ—¶å®Œæˆä»»åŠ¡ï¼Œå®è´¨ä¸Šæ˜¯é€šè¿‡ä»»åŠ¡ä¹‹é—´çš„åˆ‡æ¢å®Œæˆçš„

> å¹¶è¡Œï¼šå®é™…ä¸Šå°±æ˜¯åŒæ—¶å®Œæˆå¤šä¸ªä»»åŠ¡

### 2.å›è°ƒå‡½æ•°ï¼ˆCallbackï¼‰
å›è°ƒå‡½æ•°å°±æ˜¯æŠŠä»»åŠ¡åˆ†ä¸ºä¸¤æ®µï¼Œç¬¬ä¸€æ®µæ‰§è¡Œç»“æŸä¹‹åæ‰èƒ½æ‰§è¡Œç¬¬äºŒæ®µï¼Œä¸­é—´çš„ç­‰å¾…è¿‡ç¨‹ï¼Œå¯ä»¥æ‰§è¡Œå…¶å®ƒæ“ä½œï¼Œ
å­˜åœ¨çš„é—®é¢˜

+ å›è°ƒåœ°ç‹±,éœ€è¦è‡ªå·±å»ç†æ¸…æ¥šæ‰§è¡Œé¡ºåº
+ å›è°ƒæ˜¯å¦æ‰§è¡Œï¼Œæ‰§è¡Œäº†å¤šå°‘æ¬¡,æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œçš„
+ é”™è¯¯éš¾ä»¥è·å–ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨try...catch(å› ä¸ºå¼‚æ­¥æ“ä½œï¼Œåªæœ‰ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œéš¾ä»¥å¯»æ‰¾é”™è¯¯)
+ ä¸èƒ½ç›´æ¥return
***************************
### 3.PromiseåŸºæœ¬ä½¿ç”¨
è§£å†³å›è°ƒçš„éƒ¨åˆ†é—®é¢˜
+ å›è°ƒæ‰§è¡Œå¤šæ¬¡===> Promiseçš„resolveåªèƒ½æ‰§è¡Œä¸€æ¬¡
+ å›è°ƒå‡½æ•°æœ‰æ²¡æœ‰æ‰§è¡Œ===> Promise.race
+ æ— æ³•åˆ¤å®šå›è°ƒæ˜¯å¦è¢«æ‰§è¡Œ(å†…éƒ¨æ··æ‚äº†åŒæ­¥å¼‚æ­¥çš„å‡½æ•°ï¼Œæ¯”å¦‚å¦‚æœæœ‰ç¼“å­˜ï¼Œæ‰§è¡ŒåŒæ­¥ï¼Œæ²¡æœ‰ç¼“å­˜å°±å»è¯·æ±‚ï¼Œæ‰§è¡Œå¼‚æ­¥ï¼Œæ··æ‚å‘å¤–åªæš´éœ²ä¸€ä¸ªæ¥å£)===>thené‡Œè§„å®šäº†å¼‚æ­¥æ‰§è¡Œé¡ºåº

#### å¦‚ä½•ä¸­æ–­promiseçš„æ‰§è¡Œ
##### ç¬¬ä¸€ä¸ªthenå¼ºè¡ŒæŠ¥é”™
ä¸€ç§æ–¹æ³•æ˜¯åœ¨then 1ä¸­ç›´æ¥æŠ›é”™, è¿™æ ·å°±ä¸ä¼šæ‰§è¡Œthen 2, then 3, ç›´æ¥è·³åˆ°catchæ–¹æ³•æ‰“å°err(ä½†æ­¤æ–¹æ³•å¹¶æ²¡æœ‰å®é™…ä¸­æ–­)

```js
Promise.resolve().then(() => {
    console.log('then 1')
    throw new Error('xxx')
}).then(() => {
    console.log('then 2')
}).then(() => {
    console.log('then 3')
}).catch((err) => {
    console.log(err)
})
```
##### then 1ä¸­return ä¸€ä¸ªæ–°çš„Promise
åœ¨then 1ä¸­return ä¸€ä¸ªæ–°çš„Promise,ä½†ä¸æ”¹å˜å…¶çŠ¶æ€,è¿™æ ·è¯¥Promiseå°±ä¸€ç›´å¤„äºpeddingçŠ¶æ€,å³ä¸ä¼šæ‰§è¡Œåé¢ä»»ä½•æ–¹æ³•ï¼Œå› ä¸ºPromises/A+æ ‡å‡†ï¼šåŸPromiseå¯¹è±¡çš„çŠ¶æ€å°†è·Ÿæ–°å¯¹è±¡ä¿æŒä¸€è‡´ã€‚


```js
Promise.resolve().then(() => {
    console.log('then 1')
    return new Promise(() => {})
}).then(() => {
    console.log('then 2')
}).then(() => {
    console.log('then 3')
}).catch((err) => {
    console.log(err)
})
```
##### Promise.raceç«é€Ÿæ–¹æ³•
è®©å…¶å®ƒä¸æ‰§è¡Œ

```js
let p1 = new Promise((resolve, reject) => {
    resolve('ok1')
})
 
let p2 = new Promise((resolve, reject) => {
    setTimeout(() => {resolve('ok2')}, 10)
})
 
Promise.race([p2, p1]).then((result) => {
    console.log(result) //ok1
}).catch((error) => {
    console.log(error)
})
```



#### åŸºæœ¬ä½¿ç”¨

```
new Promise((resolve, reject) => {
  resolve('success')
  // æ— æ•ˆ
  reject('reject')
})
```

#### catch
+ æ•è·thençš„å‰ä¸€æ­¥é‡Œçš„é”™è¯¯ï¼Œthençš„rejectå’Œcatchä½œç”¨ç›¸åŒ
+ æ•è·thené‡Œçš„é”™è¯¯ï¼Œéœ€è¦åœ¨ä¸‹ä¸€ä¸ªthenæˆ–è€…catché‡Œ

```js
// bad
somethingAync.then(function() {
    return somethingElseAsync();
}, function(err) {
    handleMyError(err);
});
```

```js
// good
somethingAsync
.then(function() {
    return somethingElseAsync()
})
.then(null, function(err) {
    handleMyError(err);
});
```

```js
// good
somethingAsync()
.then(function() {
    return somethingElseAsync();
})
.catch(function(err) {
    handleMyError(err);
});
```
#### promise.then
promiseçš„thenï¼Œå¦‚æœæœ‰returnï¼Œä¼šè¢«promise.resolveåŒ…è£¹ï¼Œè¿”å›ä¾ç„¶ä¸ºpromise
#### promise.all

åªæœ‰å…¨éƒ¨éƒ½æ‰§è¡Œæ‰èƒ½æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼Œå¦‚æœp1,p2,p3éƒ½æ‰§è¡Œresolveï¼Œé‚£ä¹ˆç»“æœä¸º[1,2,3],å¦‚æœæŠŠp2æ”¹ä¸ºreject(2),é‚£ä¹ˆæ‰§è¡Œç»“æœä¸º2

```js
const p1 = new Promise((resolve, reject) => {
    resolve(1);
});

const p2 = new Promise((resolve, reject) => {
    resolve(2);
});

const p3 = new Promise((resolve, reject) => {
    resolve(3);
});

Promise.all([p1, p2, p3]).then(data => { 
    console.log(data); // [1, 2, 3] ç»“æœé¡ºåºå’Œpromiseå®ä¾‹æ•°ç»„é¡ºåºæ˜¯ä¸€è‡´çš„
}, err => {
    console.log(err);
});
```
#### Promise.race
åªè¦æœ‰ä¸€ä¸ªä¸ºrejectedæˆ–è€…resolvedå°±æ‰§è¡Œåç»­æ“ä½œ

```js
function timerPromisefy(delay) {
    return new Promise(function (resolve, reject) {
        setTimeout(function () {
            resolve(delay);
        }, delay);
    });
}
var startDate = Date.now();

Promise.race([
    timerPromisefy(10),
    timerPromisefy(20),
    timerPromisefy(30)
]).then(function (values) {
    console.log(values); // 10
});
```
#### Promiseçš„ç¼ºç‚¹
+ æ— æ³•æ•è·é”™è¯¯

```js
// æƒ³è¦çš„ç»“æœï¼Œpromiseå‡ºé”™ï¼Œä¸èƒ½è¢«æ‰“å°
const promise = new Promise(null);
console.log(233333);
//å®é™…ä¸Šï¼Œpromiseå†…éƒ¨çš„é”™è¯¯æ— æ³•å½±å“å¤–éƒ¨ï¼Œä¼šæ‰“å°2333333
let promise = new Promise(() => {
    throw new Error('error')
});
console.log(2333333);
```
+ å•ä¸€å€¼

```js
//æ¯æ¬¡å‘thenä¼ é€’çš„éƒ½ä¸ºå•ä¸€çš„å€¼ï¼Œéœ€è¦å°è£…ï¼Œè§£å°
Promise.all([Promise.resolve(1), Promise.resolve(2)])
.then(([x, y]) => {
    console.log(x, y);
});
```
+ æ— æ³•å–æ¶ˆ

```
ä¸€æ—¦å¼€å§‹ï¼Œæ— æ³•å–æ¶ˆ
```


***********************
### 4.æ‰‹å†™Promise
promiseç¿»è¯‘æ˜¯æ‰¿è¯ºï¼Œå®ƒæœ‰ä¸‰ç§çŠ¶æ€ï¼ŒçŠ¶æ€åªèƒ½ä»pendingå˜ä¸ºresolvedæˆ–è€…rejected
+ pending ç­‰å¾…ä¸­
+ fulfilledå·²æ‰§è¡Œ
+ rejected å·²æ‹’ç»

#### åŸºæœ¬Promise
è®°å¿†ï¼š
+ const that=this
+ try{fn(resolve,reject)}catch(e){reject(e)}
+ ä½¿ç”¨ new Promise((resolve,reject)=>{resolve(100)})
```
const PENDING='pending'
const RESOLVED='resolved'
const REJECTED='rejected'
function Mypromise(fn){
    const that = this
    that.state= PENDING
    that.resolvedcallback=[]
    that.rejectedcallback=[]
    that.value=null

    function resolve(value){
        if(that.state=== PENDING){
            that.state=RESOLVED
            that.value=value
            that.resolvedcallback.map((cb)=>cb(that.value))
        }
        console.log('resolve',that.value)
    }
    function reject(value){
        if(that.state === PENDING){
            that.state=REJECTED
            that.value=value
            that.rejectedcallback.map((cb)=>cb(that.value))
        }
        console.log('reject',that.value)
    }            
    try{
        fn(resolve,reject)
    }catch(e){
        reject(e)
    }
}

var peomise1=new Mypromise((resolve,reject)=>{
    resolve(100)
    reject(200)
})
```
+ then

```
è§‚å¯Ÿè€…æ¨¡å¼
thenæ”¶é›†ä¾èµ–ï¼Œæ”¾å…¥å›è°ƒå‡½æ•°æ•°ç»„é‡Œ ->
å¼‚æ­¥è§¦å‘resolve -> resolveæ‰§è¡Œä¾èµ–
```


```
Mypromise.prototype.then=function(onfullfilled,onrejected){
    const that =this
    if(that.state===PENDING){
        that.resolvedcallback.push(onfullfilled)
        that.rejectedcallback.push(onrejected)
    }
    if(that.state===RESOLVED){
        onfullfilled(that.value)
    }
    if(that.state===REJECTED){
        onrejected(that.value)
    }
}

var peomise1=new Mypromise((resolve,reject)=>{
    resolve(100)
    reject(200)
}).then(data=>{console.log(data)})
```

##### promiseçŠ¶æ€é€ä¼ ï¼š
promise A+è§„å®š thenæ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªpromiseå®ä¾‹
+ å¦‚æœ promise1çš„ onFulfilled ä¸æ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆpromise1çš„ä¸å¯å˜å€¼å°†ä¼ é€’åˆ°promise2å¹¶ä½œä¸ºpromise2çš„ä¸å¯å˜å€¼ã€‚
+ å¦‚æœ promise1çš„ onRejectedä¸æ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆpromise1çš„ä¸å¯å˜åŸå› å°†ä¼ é€’åˆ°promise2å¹¶ä½œä¸ºpromise2çš„ä¸å¯å˜åŸå› ï¼Œå¹¶ä½œä¸ºpromise2çš„ onRejected çš„å…¥å‚ã€‚
+ è¿™å°±æ˜¯Promiseçš„==çŠ¶æ€é€ä¼ ==ç‰¹ç‚¹ï¼Œå¦‚æœå½“å‰çš„promiseå®ä¾‹æ²¡æœ‰ç»‘å®šå›è°ƒå‡½æ•°ï¼Œæˆ–è€…ç»‘å®šçš„ä¸æ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆå½“å‰å®ä¾‹å°±ä¼šæŠŠå…¶çŠ¶æ€ä»¥åŠä¸å¯å˜å€¼æˆ–è€…ä¸å¯å˜åŸå› ä¼ é€’ç»™å½“å‰å®ä¾‹è°ƒç”¨.thenæ–¹æ³•è¿”å›çš„æ–°promiseå®ä¾‹ã€‚==ã€‹ä½¿ç”¨æœ€åçš„catchæ•è·ä¹‹å‰æ²¡æœ‰è¿›è¡Œå¤„ç†çš„rejectedçŠ¶æ€ã€‚
```
new MyPromise((resolve, reject) => { 
    setTimeout(() => { 
         resolve(1) 
    }, 0) 
}).then(value => { console.log('then',value) })

//ç»“æœï¼šthen pending
then 1
resolve 1
å› ä¸ºsetTimeoutå¼‚æ­¥ï¼Œæ‰€ä»¥çŠ¶æ€ä¸ºç­‰å¾…çŠ¶æ€ï¼Œå…ˆæŠŠthené‡Œçš„å‡½æ•°ä¼ é€’åˆ°å›è°ƒå‡½æ•°æ•°ç»„ï¼Œå…ˆæ‰§è¡Œäº†thenæ‰€ä¼ é€’çš„å‡½æ•°ï¼Œæ‰æ‰§è¡Œpromiseæœ¬èº«çš„å‡½æ•°
```
#### Promise A+
+ æ”¹é€ resolveå’Œrejectå‡½æ•°ï¼Œresolveåˆ¤æ–­æ˜¯å¦ä¸ºpromiseç±»å‹ï¼Œæ˜¯åˆ™æ‰§è¡Œthen
+ resolveå’Œrejectç”¨setTimeoutåŒ…è£¹

```
//resolveå‡½æ•°
    function resolve(value) { 
       if (value instanceof MyPromise) {//é¦–å…ˆéœ€è¦åˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯å¦ä¸º Promise ç±»å‹ 
           return value.then(resolve, reject) 
       } 
       setTimeout(()=>{//ä¿è¯æ‰§è¡Œé¡ºåº
        if (that.state === PENDING) { //åªæœ‰çŠ¶æ€ä¸ºç­‰å¾…ä¸­æ‰å¯ä»¥è¿›è¡ŒçŠ¶æ€æ”¹å˜å¹¶éå†å›è°ƒå‡½æ•°æ•°ç»„
            that.state = RESOLVED 
            that.value = value 
            that.resolvedCallbacks.map(cb => cb(that.value)) //æˆ–è€…ç”¨forEach
            console.log('resolve',value)
        }
       },0)
     } 
     //rejectå‡½æ•°
     function reject(value) { 
         setTimeout(()=>{
            if (that.state === PENDING) {
                that.state = REJECTED 
                that.value = value 
                that.rejectedCallbacks.map(cb => cb(that.value))
            }
         },0)
    } 
```
+ thenéœ€è¦æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œ==thenè¿”å›çš„å€¼éœ€è¦è¢«åŒ…è£¹ä¸ºpromiseå½¢å¼==ï¼Œæ‰èƒ½ç»§ç»­è°ƒç”¨thenæ–¹æ³•
+ promise2 = promise1.then(onFulfilled, onRejected); onFulfilled æˆ– onRejected æ‰§è¡Œçš„ç»“æœä¸ºx,å‡½æ•°æ—¶ä¼šè¿”å›ä¸€ä¸ª xï¼Œå¹¶ä¸”æ‰§è¡Œ Promise è§£å†³è¿‡ç¨‹è°ƒç”¨ resolvePromiseï¼Œè¿™æ˜¯ä¸ºäº†ä¸åŒçš„ Promise éƒ½å¯ä»¥å…¼å®¹ä½¿ ç”¨ï¼Œæ¯”å¦‚ JQuery çš„ Promise èƒ½å…¼å®¹ ES6 çš„ Promise
+ å¦‚æœ onFulfilled æˆ–è€… onRejected æ‰§è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸e,promise2éœ€è¦è¢«reject
+ å¦‚æœ onFulfilled ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œpromise2 ä»¥promise1çš„å€¼fulfilled
+ å¦‚æœ onRejected ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œpromise2 ä»¥promise1çš„reason rejected
+ å¦‚æœä¸ç”¨setTimeoutè¿™ç§æ–¹å¼çš„è¯ï¼Œè‹¥Promiseé‡Œé¢çš„ä»£ç æ˜¯åŒæ­¥ä»£ç ï¼Œåœ¨æ‰§è¡Œåˆ°rejectæˆ–è€…resolveçš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œthenï¼Œæ‰€ä»¥æ•°ç»„é‡Œè¿˜æ²¡æœ‰å€¼ï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨çš„è¯ä¸ä¼šæŠ¥é”™ä½†æ˜¯ä¸ä¼šè¾“å‡ºä»»ä½•ç»“æœï¼Œç”¨setTimeoutè½¬ä¸ºå¼‚æ­¥çš„è¯ï¼Œä¼šå…ˆå»æ‰§è¡Œthenæ–¹æ³•ï¼Œå°†å›è°ƒæ”¶é›†åˆ°æ•°ç»„é‡Œï¼Œç„¶åå†å»æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å°±æœ‰å€¼äº†ã€‚

```
Promiseçš„æ‰§è¡Œé¡ºåºæ˜¯new Promise -> then()æ”¶é›†å›è°ƒ -> resolve/rejectæ‰§è¡Œå›è°ƒï¼Œè¿™ä¸€é¡ºåºæ˜¯å»ºç«‹åœ¨executoræ˜¯å¼‚æ­¥ä»»åŠ¡çš„å‰æä¸Šçš„ï¼Œå¦‚æœexecutoræ˜¯ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆé¡ºåºå°±ä¼šå˜æˆnew Promise -> resolve/rejectæ‰§è¡Œå›è°ƒ -> then()æ”¶é›†å›è°ƒï¼Œresolveçš„æ‰§è¡Œè·‘åˆ°thenä¹‹å‰å»äº†ï¼Œä¸ºäº†å…¼å®¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ç»™resolve/rejectæ‰§è¡Œå›è°ƒçš„æ“ä½œåŒ…ä¸€ä¸ªsetTimeoutï¼Œè®©å®ƒå¼‚æ­¥æ‰§è¡Œã€‚
```


```
if (that.state === PENDING) { 
         // that.resolvedCallbacks.push(onFulfilled) 
         return ( promise2 = new MyPromise((resolve, reject) => { 
             that.resolvedCallbacks.push(() => { 
                 try { 
                     const x = onFulfilled(that.value) 
                     resolutionProcedure(promise2, x, resolve, reject)
                    } catch (r) { 
                        reject(r) 
                    } 
                }) 
            // that.rejectedCallbacks.push(onRejected) 
            that.rejectedCallbacks.push(() => { 
                try { 
                    const x = onRejected(that.value)
                    resolutionProcedure(promise2, x, resolve, reject)
                } catch (r) { 
                    reject(r) 
                } 
         }) 
         }))
         console.log('then pending')
    } 
```
å¯¹resolveå’Œrejectçš„æ“ä½œç±»ä¼¼ï¼Œä»¥ä¸‹å‡ ä¸ªç‚¹
+ è¿”å›promiseå½¢å¼çš„å€¼
+ ç”¨setTimeoutå’Œtry...catch
+ xä¸ºæ‰§è¡ŒonFulfilledæˆ–è€…onRejectedçš„å€¼ï¼Œå†è°ƒç”¨resolutionProcedure(promise2, x, resolve, reject)

```
if (that.state === RESOLVED) { //å¦‚æœçŠ¶æ€ä¸ºresolvedï¼Œæ‰§è¡Œå‡½æ•°
        return (promise2 = new MyPromise((resolve, reject) => { 
            setTimeout(() => { 
                 try { 
                     const x = onFulfilled(that.value) 
                     resolutionProcedure(promise2, x, resolve, reject) 
                    } catch (reason) { 
                        reject(reason) 
                    } 
                 })
            })) 
        }

    // if (that.state === REJECTED) {
    //     onRejected(that.value) 
    // } 
    if (that.state === REJECTED) { //å¦‚æœçŠ¶æ€ä¸ºresolvedï¼Œæ‰§è¡Œå‡½æ•°
        return (promise2 = new MyPromise((resolve, reject) => { 
            setTimeout(() => { 
                 try { 
                     const x = onRejected(that.value) 
                     resolutionProcedure(promise2, x, resolve, reject) 
                    } catch (reason) { 
                        reject(reason) 
                    } 
                 })
            })) 
    }
```
+ thenå¾—åˆ°çš„å€¼éœ€è¦è¿›ä¸€æ­¥ç»Ÿä¸€å¤„ç†ï¼Œå®ç°å…¼å®¹å¤šç§ Promise çš„ resolutionProcedure å‡½æ•°

```
// promise2,thençš„æˆ‘ä»¬éœ€è¦çš„è¿”å›ï¼Œxä¸ºthenæ‰§è¡ŒonFulfilledæˆ–onRejectedè¿”å›å€¼ï¼Œå¯èƒ½æ˜¯æ™®é€šå€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯promise
//resolve,rejectä¸ºpromise2çš„å¯¹åº”resolveå’Œreject
function resolutionProcedure(promise2, x, resolve, reject) { 
    if (promise2 === x) { 
        return reject(new TypeError('Error')) 
    } 
}
//é¿å…å·¡å›å¼•ç”¨é—®é¢˜ï¼Œpromise2ä¸xä¸èƒ½ç›¸ç­‰
let p = new MyPromise((resolve, reject) => { 
resolve(1)
})
let p1 = p.then(value => { return p1})
```
+ è¿›ä¸€æ­¥åˆ¤æ–­xçš„ç±»å‹
+ å¦‚æœxä¸ºæ™®é€šå€¼ï¼Œç›´æ¥resolve
+ å¦‚æœxä¸ºpromiseï¼Œé‚£ä¹ˆå®ƒå¿…ç„¶æœ‰ä¸€ä¸ªthenæ–¹æ³•ï¼Œåˆ¤æ–­x.thençš„ç±»å‹ï¼Œå¦‚æœæ˜¯æ™®é€šå€¼ï¼ˆthené“¾ç»“æŸï¼‰ï¼Œresolveå¤„ç†ï¼Œå¦‚æœä¸ºfunctionï¼Œé‚£ä¹ˆè°ƒç”¨å®ƒçš„thenæ–¹æ³•ï¼Œå¹¶æ”¹å˜è°ƒç”¨æ¬¡æ•°çš„å€¼ï¼Œç„¶åé€’å½’è°ƒç”¨ï¼ŒçŸ¥é“æœ€ç»ˆæˆä¸ºä¸€ä¸ªæ™®é€šå€¼

```
// promise2,thençš„æˆ‘ä»¬éœ€è¦çš„è¿”å›ï¼Œxä¸ºthenæ‰§è¡ŒonFulfilledæˆ–onRejectedè¿”å›å€¼ï¼Œå¯èƒ½æ˜¯æ™®é€šå€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯promise
//resolve,rejectä¸ºpromise2çš„å¯¹åº”resolveå’Œreject
function resolutionProcedure(promise2, x, resolve, reject) { 
    if (promise2 === x) { 
        return reject(new TypeError('Error')) 
    } 
    // if (x instanceof MyPromise) { 
    //      x.then(function(value) { 
    //         resolutionProcedure(promise2, value, resolve, reject) 
    //     }, reject) 
    // } 
    let called = false //é¦–å…ˆåˆ›å»ºä¸€ä¸ªå˜é‡ called ç”¨äºåˆ¤æ–­æ˜¯å¦å·²ç»è°ƒç”¨è¿‡å‡½æ•°
    if (x !== null && (typeof x === 'object' || typeof x === 'function')) { //åˆ¤æ–­ä¸ºæ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡ï¼ˆpromiseï¼‰
         try { 
            // åˆ¤æ–­å¾—åˆ°xä¸ºå‡½æ•°æˆ–è€…å¯¹è±¡ï¼ˆpromiseç±»å‹ï¼‰
            let then = x.then //åˆ¤æ–­ç±»å‹
            if (typeof then === 'function') { //åˆ¤æ–­å¾—åˆ°x.thenä¸ºå‡½æ•°ï¼Œè¯´æ˜å®ƒæ˜¯promiseé‡Œçš„thenæ–¹æ³•
                then.call(  x, y => { //ä½¿ç”¨x.thenæ–¹æ³•
                                   if (called) return //å¦‚æœå·²ç»è°ƒç”¨è¿‡ï¼Œç›´æ¥è¿”å›
                                    called = true //æ²¡æœ‰è°ƒç”¨è¿‡ï¼Œæ ‡è®°ä¸ºè°ƒç”¨è¿‡
                                    resolutionProcedure(promise2, y, resolve, reject) //ç”±äºæˆåŠŸçš„è¿”å›yè¿˜å¯èƒ½æ˜¯promiseï¼Œæ‰€ä»¥éœ€è¦é€’å½’
                                }, e => {  
                                    if (called) return 
                                    called = true 
                                    reject(e) 
                                 }) 
             } else { //åˆ¤æ–­å¾—åˆ°x.thenä¸ä¸ºå‡½æ•°ï¼Œç›´æ¥resolve
                resolve(x)
             } 
         } catch (e) { 
             if (called) return 
             called = true 
             reject(e) 
             } 
    } else { //ä¸æ˜¯å¯¹è±¡æˆ–è€…å‡½æ•°ï¼ˆä¸æ˜¯promiseï¼Œå€¼ç›´æ¥ä¼ å…¥resolveä¸­ï¼‰
        resolve(x) 
    } 
}
```
##### å®Œæ•´ç‰ˆPromise A+

```
        const PENDING='pending'
        const RESOLVED='resolved'
        const REJECTED='rejected'
        function MyPromise(fn){
            const that = this
            that.state= PENDING
            that.resolvedCallbacks=[]
            that.rejectedCallbacks=[]
            that.value=null
            function resolve(value) { 
                if (value instanceof MyPromise) {//é¦–å…ˆéœ€è¦åˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯å¦ä¸º Promise ç±»å‹ 
                    return value.then(resolve, reject) 
                } 
                setTimeout(()=>{//ä¿è¯æ‰§è¡Œé¡ºåº
                    if (that.state === PENDING) { //åªæœ‰çŠ¶æ€ä¸ºç­‰å¾…ä¸­æ‰å¯ä»¥è¿›è¡ŒçŠ¶æ€æ”¹å˜å¹¶éå†å›è°ƒå‡½æ•°æ•°ç»„
                        that.state = RESOLVED 
                        that.value = value 
                        that.resolvedCallbacks.map(cb => cb(that.value)) //æˆ–è€…ç”¨forEach
                    }
                },0)
                } 
                //rejectå‡½æ•°
                function reject(value) { 
                    setTimeout(()=>{
                        if (that.state === PENDING) {
                            that.state = REJECTED 
                            that.value = value 
                            that.rejectedCallbacks.map(cb => cb(that.value))
                        }
                    },0)
                } 
            try{
                fn(resolve,reject)
            }catch(e){
                reject(e)
            }
        }

        MyPromise.prototype.then=function(onFulfilled,onRejected){
            const that =this
            onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : v => v 
            onRejected = typeof onRejected === 'function' ? onRejected : r => {throw r } 
            if (that.state === PENDING) { 
                // that.resolvedCallbacks.push(onFulfilled) 
                return ( promise2 = new MyPromise((resolve, reject) => { 
                    that.resolvedCallbacks.push(() => { 
                        try { 
                            const x = onFulfilled(that.value) 
                            resolutionProcedure(promise2, x, resolve, reject)
                            } catch (r) { 
                                reject(r) 
                            } 
                        }) 
                    // that.rejectedCallbacks.push(onRejected) 
                    that.rejectedCallbacks.push(() => { 
                        try { 
                            const x = onRejected(that.value)
                            resolutionProcedure(promise2, x, resolve, reject)
                        } catch (r) { 
                            reject(r) 
                        } 
                }) 
                }))
            } 
            if (that.state === RESOLVED) { //å¦‚æœçŠ¶æ€ä¸ºresolvedï¼Œæ‰§è¡Œå‡½æ•°
                return (promise2 = new MyPromise((resolve, reject) => { 
                    setTimeout(() => { 
                        try { 
                            const x = onFulfilled(that.value) 
                            resolutionProcedure(promise2, x, resolve, reject) 
                            } catch (reason) { 
                                reject(reason) 
                            } 
                        })
                    })) 
                }

            // if (that.state === REJECTED) {
            //     onRejected(that.value) 
            // } 
            if (that.state === REJECTED) { //å¦‚æœçŠ¶æ€ä¸ºresolvedï¼Œæ‰§è¡Œå‡½æ•°
                return (promise2 = new MyPromise((resolve, reject) => { 
                    setTimeout(() => { 
                        try { 
                            const x = onRejected(that.value) 
                            resolutionProcedure(promise2, x, resolve, reject) 
                            } catch (reason) { 
                                reject(reason) 
                            } 
                        })
                    })) 
            }

        } 
// promise2,thençš„æˆ‘ä»¬éœ€è¦çš„è¿”å›ï¼Œxä¸ºthenæ‰§è¡ŒonFulfilledæˆ–onRejectedè¿”å›å€¼ï¼Œå¯èƒ½æ˜¯æ™®é€šå€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯promise
//resolve,rejectä¸ºpromise2çš„å¯¹åº”resolveå’Œreject
function resolutionProcedure(promise2, x, resolve, reject) { 
    if (promise2 === x) { 
        return reject(new TypeError('Error')) 
    } 
    // if (x instanceof MyPromise) { 
    //      x.then(function(value) { 
    //         resolutionProcedure(promise2, value, resolve, reject) 
    //     }, reject) 
    // } 
    let called = false //é¦–å…ˆåˆ›å»ºä¸€ä¸ªå˜é‡ called ç”¨äºåˆ¤æ–­æ˜¯å¦å·²ç»è°ƒç”¨è¿‡å‡½æ•°
    if (x !== null && (typeof x === 'object' || typeof x === 'function')) { //åˆ¤æ–­ä¸ºæ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡ï¼ˆpromiseï¼‰
         try { 
            // åˆ¤æ–­å¾—åˆ°xä¸ºå‡½æ•°æˆ–è€…å¯¹è±¡ï¼ˆpromiseç±»å‹ï¼‰
            let then = x.then //åˆ¤æ–­ç±»å‹
            if (typeof then === 'function') { //åˆ¤æ–­å¾—åˆ°x.thenä¸ºå‡½æ•°ï¼Œè¯´æ˜å®ƒæ˜¯promiseé‡Œçš„thenæ–¹æ³•
                then.call(  x, y => { //ä½¿ç”¨x.thenæ–¹æ³•
                                   if (called) return //å¦‚æœå·²ç»è°ƒç”¨è¿‡ï¼Œç›´æ¥è¿”å›
                                    called = true //æ²¡æœ‰è°ƒç”¨è¿‡ï¼Œæ ‡è®°ä¸ºè°ƒç”¨è¿‡
                                    resolutionProcedure(promise2, y, resolve, reject) //ç”±äºæˆåŠŸçš„è¿”å›yè¿˜å¯èƒ½æ˜¯promiseï¼Œæ‰€ä»¥éœ€è¦é€’å½’
                                }, e => {  
                                    if (called) return 
                                    called = true 
                                    reject(e) 
                                 }) 
             } else { //åˆ¤æ–­å¾—åˆ°x.thenä¸ä¸ºå‡½æ•°ï¼Œç›´æ¥resolve
                resolve(x)
             } 
         } catch (e) { 
             if (called) return 
             called = true 
             reject(e) 
             } 
    } else { //ä¸æ˜¯å¯¹è±¡æˆ–è€…å‡½æ•°ï¼ˆä¸æ˜¯promiseï¼Œå€¼ç›´æ¥ä¼ å…¥resolveä¸­ï¼‰
        resolve(x) 
    } 
}

const p1 = new MyPromise((resolve, reject) => {
  resolve(1)          //åŒæ­¥executoræµ‹è¯•
}).then(res => {
    console.log(res)
    return 2          //é“¾å¼è°ƒç”¨æµ‹è¯•
  })

  .then()             //å€¼ç©¿é€æµ‹è¯•
  .then(res => {
    console.log(res)
    return new MyPromise((resolve, reject) => {
      resolve(3)      //è¿”å›Promiseæµ‹è¯•
    })
  })
  .then(res => {
    console.log(res)
    throw new Error('rejectæµ‹è¯•')   //rejectæµ‹è¯•
  })
  .then(() => {}, err => {
    console.log(err)
  })
// 1 
// 2 
// 3 
// Error: rejectæµ‹è¯•
```
##### å®ç° promiseify æ–¹æ³•
ä½œç”¨ï¼šæŠŠå¼‚æ­¥å‡½æ•°è½¬æ¢ä¸ºpromise,ç›´æ¥å¯ä»¥ä½¿ç”¨then

```
let Promise = require('./bluebird');
let fs = require("fs");

var readFile = Promise.promisify(fs.readFile);
readFile("1.txt", "utf8").then(function(data) {
    console.log(data);
})
```
å†™æ³•

```
MyPromise.promisify = function(fn) {
    return function() {
        var args = Array.from(arguments);
        return new MyPromise(function(resolve, reject) {
            fn.apply(null, args.concat(function(err) {
                err ? reject(err) : resolve(arguments[1])
            }));
        })
    }
}
```
+ è¿”å›ä¸€ä¸ªpromise
+ å†…éƒ¨å°†åŸæ¥å‚æ•°åé¢æ‹¼æ¥ä¸€ä¸ªå›è°ƒå‡½æ•°å‚æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°é‡Œæ‰§è¡Œè¿™ä¸ªpromiseçš„resloveæ–¹æ³•æŠŠç»“æœä¼ å‡ºå»ï¼Œpromiseifyå°±å®ç°äº†

##### æ‰‹å†™raceæ–¹æ³•
+ **Promise.resolve(p)**ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
+ resolveæ˜¯ä¸Šè¾¹newçš„promise
+ ç›´æ¥forEachå³å¯
```
let race=function(arr){
  return new Promise((resolve,reject)=>{
    arr.forEach(item=>{
      Promise.resolve(item).then(resolve,reject)
    })
  })
}

let p1 = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve('success2')
    }, 1000)
})
let p2 = new Promise((resolve, reject) => {
    setTimeout(() => {
        reject('reject')
    }, 500)
})
// è°ƒç”¨
race([p1, p2]).then(res => {
    console.log(res);
}).catch(err => {
    console.error(err);
})
```

```
//raceæ–¹æ³• 
static race(promiseArr) {
  return new MyPromise((resolve, reject) => {
    //åŒæ—¶æ‰§è¡ŒPromise,å¦‚æœæœ‰ä¸€ä¸ªPromiseçš„çŠ¶æ€å‘ç”Ÿæ”¹å˜,å°±å˜æ›´æ–°MyPromiseçš„çŠ¶æ€
    for (let p of promiseArr) {
      MyPromise.resolve(p).then(  //Promise.resolve(p)ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
        value => {
          resolve(value)        //æ³¨æ„è¿™ä¸ªresolveæ˜¯ä¸Šè¾¹new MyPromiseçš„
        },
        err => {
          reject(err)
        }
      )
    }
  })
}
```
##### æ‰‹å†™allæ–¹æ³•
+ å½“æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆæ—¶ï¼ŒPromise.all()è¿”å›resolveï¼Œä½†å½“æœ‰ä¸€ä¸ªå¤±è´¥(reject)ï¼Œåˆ™è¿”å›å¤±è´¥çš„ä¿¡æ¯ï¼Œå³ä½¿å…¶ä»–promiseæ‰§è¡ŒæˆåŠŸï¼Œä¹Ÿä¼šè¿”å›å¤±è´¥ã€‚
+ éœ€è¦å…ˆæŠŠæ‰€æœ‰æ–¹æ³•æœé›†åˆ°ä¸€ä¸ªæ•°ç»„é‡Œ
+ promise.resolve()åŒ…è£¹
```
//é™æ€çš„allæ–¹æ³•
static all(promiseArr) {
  let index = 0
  let result = []
  return new MyPromise((resolve, reject) => {
    promiseArr.forEach((p, i) => {
      //Promise.resolve(p)ç”¨äºå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
      MyPromise.resolve(p).then(
        val => {
          index++
          result[i] = val
          //æ‰€æœ‰thenæ‰§è¡Œå, resolveç»“æœ
          if(index === promiseArr.length) {
            resolve(result)
          }
        },
        err => {
          //æœ‰ä¸€ä¸ªPromiseè¢«rejectæ—¶ï¼ŒMyPromiseçš„çŠ¶æ€å˜ä¸ºreject
          reject(err)
        }
      )
    })
  })
}
```
##### æ‰‹å†™finally
finally()æ–¹æ³•è¿”å›ä¸€ä¸ªPromiseã€‚åœ¨promiseç»“æŸæ—¶ï¼Œæ— è®ºç»“æœæ˜¯fulfilledæˆ–è€…æ˜¯rejectedï¼Œéƒ½ä¼šæ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚åœ¨finallyä¹‹åï¼Œè¿˜å¯ä»¥ç»§ç»­thenã€‚å¹¶ä¸”ä¼šå°†å€¼åŸå°ä¸åŠ¨çš„ä¼ é€’ç»™åé¢çš„then

```
Promise.prototype.finally = function (callback) {
  let P = this.constructor;
  return this.then(
    value  => P.resolve(callback()).then(() => value),
    reason => P.resolve(callback()).then(() => { throw reason })
  );
};
```

```
ä¸ºä»€ä¹ˆéœ€è¦Promise.resolve(callback()).then(() => value)
è€Œä¸èƒ½ç›´æ¥æ‰§è¡Œcallback, return value

å› ä¸ºcallbackå¦‚æœæ˜¯ä¸ªå¼‚æ­¥æ“ä½œï¼Œè¿”å›promiseå‘¢.å¸Œæœ›ç­‰callbackæ‰§è¡Œå®Œå†æ¥ç€æ‰§è¡Œ
```



##### catch,all,resolve,reject,race

```
//catchæ–¹æ³•å…¶å®å°±æ˜¯æ‰§è¡Œä¸€ä¸‹thençš„ç¬¬äºŒä¸ªå›è°ƒ
catch(rejectFn) {
  return this.then(undefined, rejectFn)
}
```

```
//é™æ€çš„resolveæ–¹æ³•
static resolve(value) {
  if(value instanceof MyPromise) return value // æ ¹æ®è§„èŒƒ, å¦‚æœå‚æ•°æ˜¯Promiseå®ä¾‹, ç›´æ¥returnè¿™ä¸ªå®ä¾‹
  return new MyPromise(resolve => resolve(value))
}
```

```
//é™æ€çš„rejectæ–¹æ³•
static reject(reason) {
  return new MyPromise((resolve, reject) => reject(reason))
}
```






### 5.Generator
ç”Ÿæˆå™¨ï¼Œå¯ä»¥è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œå¯ä»¥åœ¨å‡½æ•°çš„æŸäº›éƒ¨åˆ†åœæ­¢

```
function *foo(x) { 
  let y = 2 * (yield (x + 1)) 
  let z = yield (y / 3) 
  return (x + y + z) 
}
let it = foo(5)
console.log(it.next())   // => {value: 6, done: false}
console.log(it.next(12)) // => {value: 8, done: false}
console.log(it.next(13)) // => {value: 42, done: true}
```
+ ç¬¬ä¸€æ¬¡è°ƒç”¨next,åœåœ¨(yield (x + 1))ï¼Œè¾“å‡ºä¸º6
+ ç¬¬äºŒæ¬¡è°ƒç”¨nextï¼Œyieldè¾“å…¥å‚æ•°12ï¼Œåˆ™y=2*12ï¼Œåœåœ¨yield (y / 3) ï¼Œä¹Ÿå°±æ˜¯24/3=8
+ ç¬¬ä¸‰æ¬¡è°ƒç”¨next,yieldä¼ å…¥13ï¼Œåˆ™z=13ï¼Œy=24,x=5,å’Œä¸º42

#### è§£å†³å›è°ƒåœ°ç‹±
å°è£…ajax
```
function *fetch() {
    yield ajax(url, () => {})
    yield ajax(url1, () => {})
    yield ajax(url2, () => {})
}
let it = fetch()
let result1 = it.next()
let result2 = it.next()
let result3 = it.next()
```
### 6.è§£å†³Generatorçš„è·å–æ§åˆ¶æƒé—®é¢˜
Generatorå‡½æ•°çš„ç¼ºç‚¹ï¼Œå¿…é¡»é€šè¿‡yieldåœæ­¢ç¨‹åºï¼Œå†é€šè¿‡next()æŠŠæ–°çš„å€¼ä¼ å…¥æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œéœ€è¦æœ‰ä¸€ç§å‰ä¸€æ­¥æ‰§è¡Œç»“æŸæŠŠæ•°æ®å’Œæ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€æ­¥çš„æœºåˆ¶ï¼ˆThunk,å’Œpromiseçš„thenï¼‰

```
var fs = require('fs');
var thunkify = require('thunkify');
var readFile = thunkify(fs.readFile);

var gen = function* (){
  var r1 = yield readFile('/etc/fstab');
  console.log(r1.toString());
  var r2 = yield readFile('/etc/shells');
  console.log(r2.toString());
};
//å–å¾—å‡½æ•°çš„æ§åˆ¶æƒå¿…é¡»é€šè¿‡next(),è€Œä¸”éœ€è¦æŠŠä¸Šä¸€æ­¥çš„å€¼å†æ¬¡ä¼ å…¥
var g = gen();
var r1 = g.next();
r1.value(function(err, data){
  if (err) throw err;
  var r2 = g.next(data);
  r2.value(function(err, data){
    if (err) throw err;
    g.next(data);
  });
});
```
#### Thunkå‡½æ•°

```
ä¼ å€¼è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¡¨è¾¾å¼åœ¨ä¼ å…¥ä¹‹å‰å…ˆæ±‚å€¼ï¼Œå†è°ƒç”¨

f(x + 5)
// ä¼ å€¼è°ƒç”¨æ—¶ï¼Œç­‰åŒäº
f(6)
```

```
ä¼ åè°ƒç”¨ï¼Œå…ˆä¼ å…¥æ‰€æœ‰å€¼ï¼Œè°ƒç”¨çš„æ—¶å€™å†è®¡ç®—
f(x + 5)
// ä¼ åè°ƒç”¨æ—¶ï¼Œç­‰åŒäº
(x + 5) * 2
```
JSæ˜¯ä¼ å€¼è°ƒç”¨çš„ï¼Œè½¬æ¢ä¸ºä¼ åè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯Thunkå‡½æ•°(æœ‰äº›ç±»ä¼¼<a href="###å‡½æ•°æŸ¯é‡ŒåŒ–">å‡½æ•°æŸ¯é‡ŒåŒ–</a>)

```
var Thunk = function(fn){
  return function (){
    var args = Array.prototype.slice.call(arguments);
    return function (callback){
      args.push(callback);
      return fn.apply(this, args);
    }
  };
};
```
æ•ˆæœ
```
// æ­£å¸¸ç‰ˆæœ¬çš„readFileï¼ˆå¤šå‚æ•°ç‰ˆæœ¬ï¼‰
fs.readFile(fileName, callback);
//Thunkå‡½æ•°å¤„ç†åçš„æ•ˆæœ
var readFileThunk = Thunk(fs.readFile);
readFileThunk(fileA)(callback);
```
#### Thunkå‡½æ•°ä¸Generatorç»“åˆæ§åˆ¶æ‰§è¡Œ

+ è‡ªåŠ¨æ‰§è¡Œï¼Œç›®çš„æ˜¯è®©gené‡Œè¯»å–æ–‡ä»¶çš„æ“ä½œè‡ªåŠ¨sé¡ºåºå…¨éƒ¨æ‰§è¡Œï¼Œyieldä¹‹åéƒ½æ˜¯Thunkå‡½æ•°

```
var gen = function* (){
  var f1 = yield readFile('fileA');
  var f2 = yield readFile('fileB');
  // ...
  var fn = yield readFile('fileN');
};
```
```
// è·å–ä¼ å…¥çš„å‡½æ•°ï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œnext(),è·å–next(data)çš„å€¼
//å¦‚æœæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥é€€å‡º
//å¦‚æœæ²¡æœ‰æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œå°†nextå‡½æ•°å†ä¼ å…¥Thunkå‡½æ•°å½“ä¸­ï¼ˆresult.valueï¼‰ï¼Œç›¸å½“æ˜¯å°†generatorå½“å‰çš„æ‰§è¡Œä¸­æ–­çš„æŒ‡é’ˆä¸ä¸Šä¸€æ­¥çš„æ•°æ® è‡ªåŠ¨ä¼ å…¥ä¸‹ä¸€æ­¥
function run(fn) {
  var newfn = fn();
  function next(err, data) {
    var result = newfn.next(data);
    if (result.done) return;
    result.value(next);
  }
  next();
}
run(gen);
```
#### Promiseå¯¹è±¡ç»“åˆgeneratoræ§åˆ¶æ‰§è¡Œ

```
var fs = require('fs');
var readFile = function (fileName){
  return new Promise(function (resolve, reject){
    fs.readFile(fileName, function(error, data){
      if (error) reject(error);
      resolve(data);
    });
  });
};

var gen = function* (){
  var f1 = yield readFile('/etc/fstab');
  var f2 = yield readFile('/etc/shells');
  console.log(f1.toString());
  console.log(f2.toString());
};
```
ä½¿ç”¨ï¼Œä¹Ÿæ˜¯ç±»ä¼¼äºåˆ©ç”¨thenè·å–ä¹‹å‰çš„å€¼å†ä¼ å…¥

```
//{ value: Promise { <pending> }, done: false }ï¼Œvalueæœ¬èº«ä¸ºpromiseå¯¹è±¡
var g = gen();
g.next().value.then(function(data){
  g.next(data).value.then(function(data){
    g.next(data);
  });
})
```
è‡ªåŠ¨æ‰§è¡Œ

```
function run(gen){
  var g = gen();
  function next(data){
    var result = g.next(data);
    if (result.done) return result.value;
    result.value.then(function(data){
      next(data);
    });
  }
  next();
}
run(gen);
```
#### coå‡½æ•°
co å‡½æ•°åº“å…¶å®å°±æ˜¯å°†ä¸¤ç§è‡ªåŠ¨æ‰§è¡Œå™¨ï¼ˆThunk å‡½æ•°å’Œ Promise å¯¹è±¡ï¼‰ï¼ŒåŒ…è£…æˆä¸€ä¸ªåº“
+ Generator å‡½æ•°çš„ yield å‘½ä»¤åé¢ï¼Œåªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡

```
//ä½¿ç”¨æ–¹æ³•
var gen = function* (){
  var f1 = yield readFile('/etc/fstab');
  var f2 = yield readFile('/etc/shells');
};
...
var co = require('co');
co(gen).then(function (){
  console.log('Generator å‡½æ•°æ‰§è¡Œå®Œæˆ');
})
```
å®ç°æºç 
+ è¾“å…¥ä¸ºä¸€ä¸ªgeneratorå‡½æ•°
+ è¾“å‡ºä¸ºpromiseå¯¹è±¡ï¼Œå¦‚æœè¾“å…¥çš„generatoræ˜¯å‡½æ•°ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ç›´æ¥resolveåŒ…è£¹

```
function co(gen) {
  var ctx = this;

  return new Promise(function(resolve, reject) {
    if (typeof gen === 'function') gen = gen.call(ctx);
    if (!gen || typeof gen.next !== 'function') return resolve(gen);
  });
}
```
+ onFulfilled()æ–¹æ³•åŒ…è£¹next()æ–¹æ³•ï¼Œä¸»è¦ç”¨äºæ•è·é”™è¯¯

```
onFulfilled();
    function onFulfilled(res) {
      var ret;
      try {
        ret = gen.next(res);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }    
```
+ ç¬¬ä¸€è¡Œï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦ä¸º Generator å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œå¦‚æœæ˜¯å°±è¿”å›ã€‚
+ ç¬¬äºŒè¡Œï¼Œç¡®ä¿æ¯ä¸€æ­¥çš„è¿”å›å€¼ï¼Œæ˜¯ Promise å¯¹è±¡ã€‚
+ ç¬¬ä¸‰è¡Œï¼Œä½¿ç”¨ then æ–¹æ³•ï¼Œä¸ºè¿”å›å€¼åŠ ä¸Šå›è°ƒå‡½æ•°ï¼Œç„¶åé€šè¿‡ onFulfilled å‡½æ•°å†æ¬¡è°ƒç”¨ next å‡½æ•°ã€‚
+ ç¬¬å››è¡Œï¼Œåœ¨å‚æ•°ä¸ç¬¦åˆè¦æ±‚çš„æƒ…å†µä¸‹ï¼ˆå‚æ•°é Thunk å‡½æ•°å’Œ Promise å¯¹è±¡ï¼‰ï¼Œå°† Promise å¯¹è±¡çš„çŠ¶æ€æ”¹ä¸º rejectedï¼Œä»è€Œç»ˆæ­¢æ‰§è¡Œ
```
function next(ret) {
  if (ret.done) {
      return resolve(ret.value);
  }
  var value = toPromise.call(ctx, ret.value);
  if (value && isPromise(value)){
     return value.then(onFulfilled, onRejected); 
  }
  return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, '
        + 'but the following object was passed: "' + String(ret.value) + '"'));
    }
});
```
******************************
### 7.asyncå‡½æ•°(spawnçš„å®ç°)
async å‡½æ•°å°±æ˜¯å°† Generator å‡½æ•°çš„æ˜Ÿå·ï¼ˆ*ï¼‰æ›¿æ¢æˆ asyncï¼Œå°† yield æ›¿æ¢æˆ awaitã€‚async å‡½æ•°çš„å®ç°ï¼Œå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚

```

async function fn(args){
 // ...
}
// ç­‰åŒäº
function fn(args){ 
  return spawn(function*() {
    // ...
  }); 
}
```
==spawnå‡½æ•°çš„å®ç°==

```
function spawn(genF) {
  return new Promise(function(resolve, reject) {
    var gen = genF();
    function step(nextF) {
      try {
        var next = nextF();
      } catch(e) {
        return reject(e); 
      }
      if(next.done) {
        return resolve(next.value);
      } 
      Promise.resolve(next.value).then(function(v) {
        step(function() { return gen.next(v); });      
      }, function(e) {
        step(function() { return gen.throw(e); });
      });
    }
    step(function() { return gen.next(undefined); });
  });
}
```
********************
### 8.å¸¸è§çš„å®šæ—¶å™¨å‡½æ•°
setsetTimeout()å’ŒsetInterval()çš„äº‹ä»¶å¯èƒ½éƒ½ä¸ä¼šç‰¹åˆ«å‡†ç¡®æ²¡å…·ä½“åŸå› ä¸JSè¿è¡Œæœºåˆ¶æœ‰å…³
<a href="### JSè¿è¡Œæœºåˆ¶">JSè¿è¡Œæœºåˆ¶</a>
#### setTimeout()

```
setTimeout(function(){...},delay)
```
#### setInterval()

```
setInterval(function(){...},delay)
```
#### setTimeout()ä¸setIntervalçš„å®ç°
setTimeout()æ–¹æ³•åœ¨ç­‰å¾…æŒ‡å®šçš„æ¯«ç§’æ•°ä¹‹åæ‰§è¡Œä¸€ä¸ªå‡½æ•°ã€‚setInterval()å¯ä»¥é‡å¤æ‰§è¡Œ

**setTimeout()å®ç°setInterval**

```
function mysetinterval(fn,delay){
    function interval(){
        fn();
        setTimeout(interval,delay)
    }
    setTimeout(interval,delay)
}
function myfn(){
    console.log('1')
}

mysetinterval(myfn,1000)
```


#### requestAnimationFrame

+ æµè§ˆå™¨æ¯ç§’æœ€å¤šåªèƒ½é‡ç»˜60æ¬¡ï¼ŒrequestAnimationFrameçš„åŸºæœ¬æ€æƒ³å°±æ˜¯ä¸è¿™ä¸ªåˆ·æ–°é¢‘ç‡ä¿æŒåŒæ­¥ï¼Œåˆ©ç”¨è¿™ä¸ªåˆ·æ–°é¢‘ç‡è¿›è¡Œé¡µé¢é‡ç»˜ã€‚

```
//å›è°ƒå‡½æ•°ä¼šåœ¨é‡ç»˜ä¹‹å‰è°ƒç”¨
requestID = window.requestAnimationFrame(callback); 
// å–æ¶ˆ
cancelAnimationFrame(...);
```
æ¯”å¦‚ï¼Œé•¿åˆ—è¡¨åˆ†æ‰¹æ¬¡è¿›è¡Œæ¸²æŸ“

```
var total = 100000;
var size = 100;
var count = total / size;
var done = 0;
var ul = document.getElementById('list');

function addItems() {
    var li = null;
    var fg = document.createDocumentFragment();
    for (var i = 0; i < size; i++) {
        li = document.createElement('li');
        li.innerText = 'item ' + (done * size + i);
        fg.appendChild(li);
    }
    ul.appendChild(fg);
    done++;
    if (done < count) {
        requestAnimationFrame(addItems);
    }
};
requestAnimationFrame(addItems);
```
å¯¹setIntervalè¿›è¡Œæ”¹è¿›

```
function setInterval(callback, interval) {
  let timer
  const now = Date.now
  let startTime = now()
  let endTime = startTime
  const loop = () => {
    //é‡ç»˜å‰è°ƒç”¨ä¸€æ¬¡loop
    timer = window.requestAnimationFrame(loop)
    //æ‰§è¡Œloop
    endTime = now()
    if (endTime - startTime >= interval) {
      startTime = endTime = now()
      callback(timer)
    }
  }
  //ç»“æŸåè°ƒç”¨ä¸‹ä¸€æ¬¡loop
  timer = window.requestAnimationFrame(loop)
  return timer
}
let a = 0
setInterval(timer => {
  console.log(1)
  a++
  //å–æ¶ˆè°ƒç”¨
  if (a === 3) cancelAnimationFrame(timer)
}, 1000)
<div class="md-section-divider"></div>
```
***********************
### 9.setTimeoutå’Œpromiseçš„åŒºåˆ«
Promise æ˜¯å¾®ä»»åŠ¡ï¼ŒsetTimeout æ˜¯å®ä»»åŠ¡ï¼ŒåŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œpromise.thenæ€»æ˜¯å…ˆäº setTimeout æ‰§è¡Œã€‚

# asyncã€await ç»†èŠ‚

èµ„æ–™ï¼šhttps://juejin.cn/post/7194744938276323384#heading-1

## asyncçš„è¿”å›å€¼

`async`å‡½æ•°åœ¨æŠ›å‡ºè¿”å›å€¼æ—¶ï¼Œä¼šæ ¹æ®è¿”å›å€¼**ç±»å‹**å¼€å¯**ä¸åŒæ•°ç›®çš„å¾®ä»»åŠ¡**

- returnç»“æœå€¼ï¼šé`thenable`ã€é`promise`ï¼ˆä¸ç­‰å¾…ï¼‰
- returnç»“æœå€¼ï¼š`thenable`ï¼ˆç­‰å¾… 1ä¸ª`then`çš„æ—¶é—´ï¼‰
- returnç»“æœå€¼ï¼š`promise`ï¼ˆç­‰å¾… 2ä¸ª`then`çš„æ—¶é—´ï¼‰

```js
async function testC () {
Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  resolve()
Â  Â  })
} 

testC().then(() => console.log(1));
Promise.resolve()
Â  Â  .then(() => console.log(2))
Â  Â  .then(() => console.log(3))
Â  Â  .then(() => console.log(4))
// (ç­‰å¾…ä¸¤ä¸ªthen)æœ€ç»ˆç»“æœ: 2 3 1 4
```

## **await å³å€¼ç±»å‹åŒºåˆ«**

+ `await`åé¢æ¥é `thenable` ç±»å‹ï¼Œä¼šç«‹å³å‘å¾®ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡`then`ï¼Œ**ä½†ä¸éœ€ç­‰å¾…**
+ `await` åé¢æ¥ `thenable` ç±»å‹ï¼Œéœ€è¦**ç­‰å¾…ä¸€ä¸ª `then` çš„æ—¶é—´ä¹‹å**æ‰§è¡Œ
+ `await` åé¢æ¥ promise ç±»å‹ï¼Œ éœ€è¦**ç­‰å¾…ä¸€ä¸ª `then` çš„æ—¶é—´ä¹‹å**æ‰§è¡Œï¼ˆTC 39(ECMAScriptæ ‡å‡†åˆ¶å®šè€…) å¯¹`await` åé¢æ˜¯ `promise` çš„æƒ…å†µå¦‚ä½•å¤„ç†è¿›è¡Œäº†ä¸€æ¬¡ä¿®æ”¹ï¼Œ**ç§»é™¤**äº†é¢å¤–çš„ä¸¤ä¸ªå¾®ä»»åŠ¡ï¼Œåœ¨**æ—©æœŸç‰ˆæœ¬**ï¼Œä¾ç„¶ä¼šç­‰å¾…ä¸¤ä¸ª `then` çš„æ—¶é—´ï¼‰
+  **å®Œå…¨å¯ä»¥å°† `await` åé¢çš„ä»£ç å¯ä»¥çœ‹åšåœ¨ `then` é‡Œé¢æ‰§è¡Œçš„ç»“æœ**

```js
function func () {
 Â  Â console.log(2);
}
async function test () {
 Â  Â console.log(1);
 Â  Â await func();
 Â  Â console.log(3);
}
test();
console.log(4);

// æœ€ç»ˆç»“æœğŸ‘‰: 1 2 4 3
```

## å…¶ä»–

`await`ä¸€å®šè¦ç­‰åˆ°å³ä¾§çš„è¡¨è¾¾å¼æœ‰**ç¡®åˆ‡çš„å€¼**æ‰ä¼šæ”¾è¡Œï¼Œå¦åˆ™å°†ä¸€ç›´ç­‰å¾…ï¼ˆé˜»å¡å½“å‰`async`å‡½æ•°å†…çš„åç»­ä»£ç ï¼‰

```js
function func () {
 Â  Â return new Promise((resolve) => {
 Â  Â  Â  Â console.log('B')
 Â  Â  Â  Â // resolve() æ•…æ„ä¸€ç›´ä¿æŒpending
 Â   })
}
async function test () {
 Â  Â console.log(1);
 Â  Â await func()
 Â  Â console.log(3);
}
test();
console.log(4);
// æœ€ç»ˆç»“æœğŸ‘‰: 1 B 4 (æ°¸è¿œä¸ä¼šæ‰“å°3)
```

